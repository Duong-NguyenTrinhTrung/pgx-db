{% load static %}
{% csrf_token %}

{% block addon_css %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="{% static 'drug/css/atc_lookup.css' %}">
{% endblock %}

{% block content %}
    {% autoescape off %}
        {% if input %}
            {% if search_result|length > 1 %}
                <p>Found {{ search_result|length }} entries {{query_option}} '{{ input }}'.</p>
            {% else %}
                <p>Found {{ search_result|length }} entry {{query_option}} '{{ input }}'.</p>
            {% endif %}
        {% endif %}
        <div id="query_result">
            <ul class="tree">
                {% for rs in search_result %}
                    <li>
                        {{ rs.id }} - <a href="#" class="desc atc_sub_levels"
                        data-remote-url="{% url 'get-atc-sub-levels' %}"
                        data-atc-code="{{ rs.id }}" 
                        data-target="#query_result">{{ rs.name }} </a>
                    </li>
                {% endfor %}
            </ul>
        </div>

        <p>{{data}}</p>
    {% endautoescape %}
{% endblock %}

{% block addon_js %}
    <script>
        $('.atc_sub_levels').click(function (e) {
            alert("we are here");
            e.preventDefault();
            let atc_code = $(this).data('atc-code');
            let url = $(this).data('remote-url');
            
            // Pass the clicked element as an argument to handleAjaxResponse
            handleAjaxResponse(this, url, atc_code);
        });

        function handleAjaxResponse(clickedElement, url, atc_code) {
            $.ajax({
                url: url,
                type: "GET",
                data: {
                    'atc_code': atc_code,
                },
                success: function (response) {
                    // Append sub unordered list to the clicked element
                    var subList = '<ul><li>Subitem 1</li><li>Subitem 2</li></ul>';
                    $(clickedElement).append(subList);
                },
                error: function (xhr, status, error) {
                    alert('AJAX Error:', error);
                }
            });
}
    </script>
{% endblock %}