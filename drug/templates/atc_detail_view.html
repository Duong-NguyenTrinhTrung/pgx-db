{% extends "home/base.html" %}
{% load static %}
{% csrf_token %}

{% block addon_css %}
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="{% static 'drug/css/atc_lookup.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'drug/css/atc_detail.css' %}">
    <style>
        .tooltip {
            background-color: #fff;
            color: #333333;
            font-weight: bolder;
            padding: 2px 3px;
            border-radius: 5px;
            font-size: 14px;
            position: absolute;
            z-index: 999;
            border: 1px solid #333333;
          }
        
          a:hover {
            cursor: pointer;
            }
        #atc_level_network_statistics{
            /* height: 400px; */
            display: none;
            width: 98%;
        }
        #atc_level_network_statistics span{
            font-size: 16px;
            color: #337ab7; 
            font-weight: bold;
        }

        #genebased-burden-distribution-area{
            display: none;
        }
        fieldset { 
            display: block;
            margin-left: 2px;
            margin-right: 2px;
            padding-top: 0.35em;
            padding-bottom: 0.625em;
            padding-left: 0.75em;
            padding-right: 0.75em;
            border: 2px groove (internal value);
            }
        legend {
            border-bottom: unset;
        }

        .spinner {
            border: 4px solid #c0bdbd;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .carrier{
            background-color: #f9c80e;
        }
        .target{
            background-color: #ff99c8;
        }
        .transporter{
            background-color: #662e9b;
        }
        .enzyme{
            background-color: #43bccd;
        }

        /* .text {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            text-align: center;
            line-height: 100px;
            vertical-align: middle;
            padding: 30px;
        } */

        .text.target {
            background: #ff99c8;
            color: white;
        }
        .text.transporter {
            background: #662e9b;
            color: white;
        }
        .text.carrier {
            background: #f9c80e;
            color: white;
        }
        .text.enzyme {
            background: #43bccd;
            color: white;
        }

        mark {
            background-color: yellow;
            border: 1px solid black;
            }
        
    </style>
    
{% endblock %}

{% block content %}
    {% autoescape off %}
        <div class="grid-container">
        {% include 'atc_detail/left_navigation.html' %}
            <div id="atc_right" class="col-8">
                <!-- block for showing the drug table -->
                <div id='drug-table'>
                </div>
                <!-- block for showing the atc level network statistics -->
                <div id='atc_level_network_statistics' style="border: #b4b1b1 1px solid">
                    <p>
                        <span id="atc_level_network_statistics_text"> </span>
                    </p>
                    <div class="row">
                        <div class="col-md-2 col-sm-12" >
                                <div class="card-body text-center" style="margin-left: 5px; margin-top: 20px;">
                                    <p style="font-style: italic; text-align: left;">Mode of action</p>
                                    <div id="chart-container-ATC-interaction-type" style="width: 150px; height: 150px;">
                                        <svg id="pie-chart-ATC-interaction-type"></svg>
                                    </div>
                                </div>
                        </div>
                        <div class="col-md-2 col-sm-12" >
                            <div class="card-body text-center" style="margin-left: 5px; margin-top: 20px;">
                                <p style="font-style: italic; text-align: left;">Drug type</p>
                                <div id="chart-container-ATC-drug-type" style="width: 150px; height: 150px;">
                                    <svg id="pie-chart-ATC-drug-type"></svg>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-12" >
                                <div class="card-body text-center" style="margin-left: 5px; margin-top: 20px;">
                                    <p style="font-style: italic; text-align: left;">Drug clinical status</p>
                                    <!--PieChart Code here-->
                                    <div id="chart-container-ATC-drug-status" style="width: 150px; height: 150px;">
                                        <svg id="pie-chart-ATC-drug-status"></svg>
                                    </div>
                                </div>
                        </div>
                    </div>
                    <div class="row" id="genebased-burden-distribution-area">
                        <div id="genebased-burden-distribution" class="col-md-12 col-sm-12" >
                                <button
                                    onclick="tableToExcel($(this))"
                                    type="button"
                                    class="btn btn-primary exportBtn"
                                    style="width: 120px; float: left; margin-right: 20px; "
                                    >
                                    Export to Excel
                                </button>
                                <div style="display: flex; gap: 10px; flex-direction: row;" >
                                    <div class="burden-data-control-div">
                                        <fieldset style="width:250px; border-radius: 5px;">
                                          <legend style="font-size: 14px; margin-bottom:0; text-decoration: none; color: #337ab7;">Burden data</legend>
                                          <input id="genebased-burden-control" data-atc-code="" name="burden-control" type="radio" value="gene-based" checked="">
                                          <label for="genebased-burden-control">Gene-based</label>
                                          <input id="variant-based-burden-control" data-atc-code="" name="burden-control" type="radio" value="variant-based">
                                          <label for="variant-based-burden-control">Variant-based</label>
                                        </fieldset>
                                    </div>
                                    <div class="clinical-pgx-data-control-div">
                                        <fieldset style="width:250px; border-radius: 5px;">
                                          <legend style="font-size: 14px; margin-bottom:0; text-decoration: none; color: #337ab7;">Clinical PGx data</legend>
                                          <input id="genebased-clinical-pgx-control" data-atc-code="" name="clinical-pgx-control" type="radio" value="gene-based-clinical-pgx" checked="">
                                          <label for="genebased-clinical-pgx-control">Gene-based</label>
                                          <input id="variant-based-clinical-pgx-control" data-atc-code="" name="clinical-pgx-control" type="radio" value="variant-based-clinical-pgx">
                                          <label for="variant-based-clinical-pgx-control">Variant-based</label>
                                        </fieldset>
                                    </div>
                            </div>
                            
                            <p id="waiting-prompt" style="text-align: center; display: none"><i> <mark>Please kindly wait when the data is being loaded! </i></mark> </p>
                            <div class="spinner" style="display: none; margin: auto;">
                            </div>
                            <!-- A datatable here  -->
                            <div  id="genebased-burden-distribution-div" style="margin-top: 20px;">
                            </div>
                        </div>
                    </div>
                    
                </div>
                <!-- block for showing network -->
                <div class="forcenetworkgraph" id="graphvisibility" style="display: none; width: 100%; margin: 10px 0; height: 90%; ">
                    <p> <span style="color: red;" id="network_overview"></span> </p>
                    <iframe id="myIframe" style="
                                                display: none;
                                                width: 98%;
                                                height: 100%;
                                                border: #b4b1b1 1px solid;
                                                margin-right: 5px;">
                    </iframe>
                </div>
                <!-- block for showing the target table -->
                <div id="target-table" style="display: none;">
                    <span style="font-style: italic; margin-bottom: 10px;" id="info-target-table"></span>
                    <!-- table  -->
                    <div id="associated_target_tbl">
                        <table id="associated_target_tbl" >
                            <thead style="text-align: left;">
                                <tr style="background-color: #f2f2f2;">
                                    <th style="white-space: nowrap;">Target &nbsp; &nbsp; &nbsp; &nbsp;</th>
                                    <th style="white-space: nowrap;">No. of drugs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</th>
                                    <th style="white-space: normal;">List of drugs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</th>
                                    <th style="white-space: nowrap;">PGx information &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
                                        &nbsp; &nbsp; &nbsp;</th>
                                    <th>Other &nbsp; &nbsp;&nbsp;  &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;</th>
                                </tr>
                            </thead>
                            <tbody id="content-target-table">
                            </tbody>
                        </table>
                    </div>
                    <!-- plots below the target table  -->
                    <div class="row">
                        <div class="col-md-2 col-sm-12" >
                            <div class="card-body text-center" style="margin-top: 20px;">
                                <p style="font-style: italic; text-align: left;">Mode of action</p>
                                <!--PieChart Code here-->
                                <div id="chart-container-interaction-type" style="width: 200px; height: 200px;">
                                    <svg id="pie-chart-interaction-type"></svg>
                                </div>
                                <!--PieChart End here-->
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-12" >
                            <div class="card-body text-center" style="margin-top: 20px;">
                                <p style="font-style: italic; text-align: left;">Drug type</p>
                                <!--PieChart Code here-->
                                <div id="chart-container-drug-type" style="width: 200px; height: 200px;">
                                    <svg id="pie-chart-drug-type"></svg>
                                </div>
                                <!--PieChart End here-->
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-12" >
                            <div class="card-body text-center" style="margin-top: 20px;">
                                <p style="font-style: italic; text-align: left;">Drug clinical status</p>
                                <!--PieChart Code here-->
                                <div id="chart-container-drug-status" style="width: 200px; height: 200px;">
                                    <svg id="pie-chart-drug-status"></svg>
                                </div>
                                <!--PieChart End here-->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endautoescape %}
{% endblock %}

{% block addon_js %}

    <script src="{% static 'home/js/d3.v7.min.js' %}"></script> 
    <script src="{% static 'drug/js/target_table_statistics.js' %}"></script>  
    <script src="{% static 'drug/js/atc_network_statistics.js' %}"></script>  

    <script src="{% static 'home/js/datatables.min.js' %}"></script>
    <script src="{% static 'home/js/bootstrap2-toggle.min.js' %}"></script>
    <script src="{% static 'home/js/jquery.dataTables.yadcf.js' %}"></script>
    <script src="{% static 'home/js/dataTables.buttons.min.js' %}"></script>

   

    <script>
        // JavaScript for toggling the visibility of nested lists
        document.querySelectorAll('.tree .desc').forEach(function (el) {
            el.addEventListener('click', function () {
                var parentLi = el.parentElement; 
                var ul = parentLi.querySelector('ul'); 
                if (ul) {
                    if (ul.style.display === "" || ul.style.display === "none") {
                        ul.style.display = 'block';
                    } else {
                        if (ul.style.display === 'block') {
                            ul.style.display = 'none';
                        }
                    }
                }
            });
        });
    </script>

    <script>

            var countClick=0;
            var timer = null;
            function showData(event, uniProt_ID) {
                countClick++;
                if (countClick === 1) {
                    timer = setTimeout(function() {
                        countClick = 0;
                        showTargetTable(uniProt_ID)
                    }, 500);
                } else {
                    clearTimeout(timer);
                    var urlOpen = event.getAttribute("data-href");
                    window.open(urlOpen, "_blank");
                    countClick =0 ;
                }
            }
            function showTargetTable(uniProt_ID){
                $.ajax(
                    {
                        url: "{% url 'get-drug-list-by-uniprotID' %}?uniProt_ID="+uniProt_ID,
                        type: "GET",
                        success: function (response) {
                            displayDrugListByUniProt_ID(response.response_data);
                            const target_type_data = [
                                    { category: "Target", value: response.response_data.NoOfTargetTypes },
                                    { category: "Enzyme", value: response.response_data.NoOfEnzymeTypes },
                                    { category: "Carrier", value: response.response_data.NoOfCarrierTypes },
                                    { category: "Transporter", value: response.response_data.NoOfTransporterTypes },
                                ];
                            createPieChartForTargetType(target_type_data);
                            const drug_type_data = [
                                    { category: "Small Molecule", value: response.response_data.NoOfSmallMolecule },
                                    { category: "Biotech", value: response.response_data.NoOfBiotech },
                                ];
                            createPieChartForDrugType(drug_type_data);
                            const drug_status_data = [
                                    { category: "Nutraceutical", value: response.response_data.NoOfNutraceuticalDrug },
                                    { category: "Experimental", value: response.response_data.NoOfExperimentalDrug },
                                    { category: "Investigational", value: response.response_data.NoOfInvestigationalDrug },
                                    { category: "Approved", value: response.response_data.NoOfApprovedDrug },
                                    { category: "VetApproved", value: response.response_data.NoOfVetApprovedDrug },
                                    { category: "Illicit", value: response.response_data.NoOfIllicitDrug },
                                ];
                            createPieChartForDrugStatus(drug_status_data);
                        },
                        error: function (xhr, status, error) {
                            console.log('AJAX Error:', error);
                        }
                    });
            }

            function showOneDrugLevelNetworkStatistics(drug_id){
                $.ajax(
                    {
                        url: "{% url 'get-drug-association' %}?drug_id="+drug_id,
                        type: "GET",
                        success: function (response) {
                            // displayStatisticsByAtcCode(response.response_data);
                            const target_type_data = [
                                    { category: "Target", value: response.NoOfTargetTypes },
                                    { category: "Enzyme", value: response.NoOfEnzymeTypes },
                                    { category: "Carrier", value: response.NoOfCarrierTypes },
                                    { category: "Transporter", value: response.NoOfTransporterTypes },
                                ];
                            createPieChartForATCTargetType(target_type_data);
                            const drug_type_data = [
                                    { category: "Small Molecule", value: response.NoOfSmallMolecule },
                                    { category: "Biotech", value: response.NoOfBiotech },
                                ];
                            createPieChartForATCDrugType(drug_type_data);
                            const drug_status_data = [
                                    { category: "Nutraceutical", value: response.NoOfNutraceuticalDrug },
                                    { category: "Experimental", value: response.NoOfExperimentalDrug },
                                    { category: "Investigational", value: response.NoOfInvestigationalDrug },
                                    { category: "Approved", value: response.NoOfApprovedDrug },
                                    { category: "VetApproved", value: response.NoOfVetApprovedDrug },
                                    { category: "Illicit", value: response.NoOfIllicitDrug },
                                ];
                            createPieChartForATCDrugStatus(drug_status_data);
                        },
                        error: function (xhr, status, error) {
                            console.log('AJAX Error:', error);
                        }
                    });
            }

            function showAtcLevelNetworkStatistics(atc_code){
                $.ajax(
                    {
                        url: "{% url 'get-statistics-by-atc' %}?atc_code="+atc_code,
                        type: "GET",
                        success: function (response) {
                            // displayStatisticsByAtcCode(response.response_data);
                            const target_type_data = [
                                    { category: "Target", value: response.NoOfTargetTypes },
                                    { category: "Enzyme", value: response.NoOfEnzymeTypes },
                                    { category: "Carrier", value: response.NoOfCarrierTypes },
                                    { category: "Transporter", value: response.NoOfTransporterTypes },
                                ];
                            createPieChartForATCTargetType(target_type_data);
                            const drug_type_data = [
                                    { category: "Small Molecule", value: response.NoOfSmallMolecule },
                                    { category: "Biotech", value: response.NoOfBiotech },
                                ];
                            createPieChartForATCDrugType(drug_type_data);
                            const drug_status_data = [
                                    { category: "Nutraceutical", value: response.NoOfNutraceuticalDrug },
                                    { category: "Experimental", value: response.NoOfExperimentalDrug },
                                    { category: "Investigational", value: response.NoOfInvestigationalDrug },
                                    { category: "Approved", value: response.NoOfApprovedDrug },
                                    { category: "VetApproved", value: response.NoOfVetApprovedDrug },
                                    { category: "Illicit", value: response.NoOfIllicitDrug },
                                ];
                            createPieChartForATCDrugStatus(drug_status_data);
                        },
                        error: function (xhr, status, error) {
                            console.log('AJAX Error:', error);
                        }
                    });
            }
            function showAtcLevelNetworkBurden(atc_code){
                $.ajax(
                    {
                        url: "{% url 'get-gene-based-burden-data-by-atc' %}?atc_code="+atc_code,
                        type: "GET",
                        success: function (response) {
                            //chart-container-ATC-gene-based-burden
                            const ATC_gene_based_burden_data = [
                                    { category: "p_value_target", value: response.p_value_target },
                                    { category: "p_value_transporter", value: response.p_value_transporter },
                                    { category: "p_value_carrier", value: response.p_value_carrier },
                                    { category: "p_value_enzyme", value: response.p_value_enzyme },
                                    { category: "beta_value_target", value: response.beta_value_target },
                                    { category: "beta_value_transporter", value: response.beta_value_transporter },
                                    { category: "beta_value_carrier", value: response.beta_value_carrier },
                                    { category: "beta_value_enzyme", value: response.beta_value_enzyme },
                                ];
                            createPieChartForATCGeneBasedBurden(ATC_gene_based_burden_data);
                        },
                        error: function (xhr, status, error) {
                            console.log('AJAX Error:', error);
                        }
                    });
            }

            function displayDrugListByUniProt_ID(data) {
                $("#content-target-table").html('');

                var target_area = document.getElementById('target-table');
                $("#infor-target-table").html(`<i>More information of <b>${data.Target} </b>`);

                    var drug_list = [];
                    for (var j = 0; j<data.ListOfDrugIDs.length;j++) {
                        var drug_url = "{% url 'drug_network' %}" + "?drug_bank_id=" + data.ListOfDrugIDs[j];
                        drug_list.push(`<i class="fa-solid fa-pills"><a href="#" class="associated_drug" 
                                    data-drugbank_id="${data.ListOfDrugIDs[j]}"
                                    onclick="toggleDivVisibility(this, '${drug_url}'); #chart" 
                                    data-target="#atc_right"> <span style="font-style: normal; font-family: 'Helvetica', 'Arial', sans-serif;">${data.ListOfDrugNames[j]}</span></a></br>`);
                }

                var tableHtml = `
                        <tr style="white-space: nowrap; background-color: rgba(241, 124, 14, 0.2);">
                            <td>${data.Genename}</td>
                            <td>${data.NoOfDrugs}</td>
                            <td style="white-space: normal;"><div id="list_of_drug_cell">${drug_list.join("")}</div></td>
                            <td style="white-space: normal;">Coming soon</td>
                            <td class="long-content" >Coming soon</td>
                        </tr>
                        `;
                $("#content-target-table").html(tableHtml);
                $('html, body').animate({
                    scrollTop: $('#content-target-table').offset().top
                }, 2000);
                $("#target-table").show();
                var target_statistics_plot = document.createElement("div");
                target_statistics_plot.setAttribute("id", "target_statistics_plot");

                var drug_type_statistics_plot = document.createElement("div");
                drug_type_statistics_plot.setAttribute("id", "drug_type_statistics_plot");
            }
                
            // Function to show visualization
            function toggleDivVisibility(element, url) {
                var drugBankId = element.getAttribute('data-drugbank_id');
                var iframe = $("#myIframe");
                // var url = "https://entertainmentbuz.com/visual/d3/index1.html";
                iframe.attr('src', url);  // Set the iframe source using jQuery

                //showing the visualization module
                iframe.css('display', 'block');
                var element = $("#graphvisibility");
                element.css('display', 'block');
                element.css('color', 'grey');
            }

            function getHeaderContent(element) {
            var content = "";
            element.childNodes.forEach(function(value){
                if(value.nodeType === Node.TEXT_NODE) { 
                    // console.log("Current textNode value is : ", value.nodeValue.trim());
                    // sChildTextSum += value.nodeValue;
                    content += ` ${value.nodeValue.trim()}`;
                }
            });
            return content;
        }

            function tableToExcel(element){
                atc_code = element.data('atc-code');
                var encabezado = '<html><head><meta http-equiv="content-type" content="text/plain; charset=UTF-8"/><style> table, td {border:thin solid black} table {border-collapse:collapse}</style></head><body><table>';

                var header_el = $('#headers')
                var header_th_els = header_el.find('th')
                var header = ''
                for (var th_i = 0; th_i < header_th_els.length; th_i++) {
                    header += '<th>' + getHeaderContent(header_th_els[th_i])+ '</th>'
                }
                header = '<tr>' + header + '</tr>'
                header = '<thead>' + header + '</thead>'
                var excel_content = ''
                // Lay toan bo data trong datatable, chi lay cac rows thoa man dieu kien filter
                var rows = $('#genebased-burden-distribution-table').DataTable().rows({search: 'applied'}).data()
                for (var i = 0; i < rows.length; i++) {
                    var row = rows[i]
                    excel_content += '<tr>'
                    for (var j = 0; j < row.length; j++) {
                        excel_content += '<td>' + row[j] + '</td>'
                    }
                    excel_content += '</tr>'
                }

                var piePagina = "</table></body></html>";
                var tabla = encabezado + header + excel_content + piePagina;
                var myBlob = new Blob([tabla], {type: 'application/vnd.ms-excel'});
                var url = window.URL.createObjectURL(myBlob);
                var a = document.createElement("a");
                document.body.appendChild(a);
                a.href = url;
                a.download = `${atc_code}.xls`;
                a.click();

                setTimeout(function () {
                    window.URL.revokeObjectURL(url);
                }, 0);
            }
    </script>

    <!-- Showing all drugs associated with an ATC code -->
    <script>
        $(document).ready(function () 
        {
            function clean_drug_network() {
                var drug_network = $('#graphvisibility');
                drug_network.css('display', 'none');
            }

            // Showing all drugs associated with an ATC code
            function list_associated_drugs_in_table(response) 
            {
                var right_panel = document.getElementById('drug-table');
                right_panel.innerHTML = "";
                var right_panel_text = document.createElement("span");
                right_panel_text.style.fontSize = "16px";
                right_panel_text.style.color = '#337ab7'; 
                right_panel_text.style.fontWeight = "bold";
                var right_panel_text_guide = document.createElement("span");
                right_panel_text_guide.style.fontSize = "14px";

                var associations = response.associations;
                var drug_bank_ids = [];
                // Check if the 'associations' key exists in the JSON response
                if (associations.length > 0) 
                {
                    var tableHtml = '<table id="associated_drug_tbl" ><thead style="text-align: left;"><tr><th style="white-space: nowrap;">Drugbank ID</th><th style="white-space: nowrap;">Drug name</th><th style="white-space: nowrap; text-align: center;">No. of interacting proteins</th><th style="white-space: nowrap;">List of interacting proteins</br><i>(Show in gene names)</i> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</th><th>Short description</th></tr></thead><tbody>';
                    
                    for (var i = 0; i < associations.length; i++) {
                        var row = associations[i];
                        drug_bank_ids.push(row.drug_bankID);
                        var drug_url = "{% url 'drug_network' %}" + "?drug_bank_id=" + row.drug_bankID;
                        var targetLinks = [];
                        for (var j = 0; j<row.target_list.length;j++) {
                            var className = "enzyme"
                            if (row.target_list[j].moa=="target"){
                                className="target";
                            }
                            else if(row.target_list[j].moa=="transporter")
                            {
                                className="transporter";   
                            }
                            else if(row.target_list[j].moa=="carrier"){
                                className = "carrier";
                            }
                            targetLinks.push(`<a style="color: white;" class="uniProt_ID ${className}" onclick="showData(this, '${row.target_list[j].uniProt_ID}')" target="_blank" data-href="/gene/${row.target_list[j].gene_id}"> ${row.target_list[j].genename}</a>`);
                        }
                        tableHtml += `
                        <tr style="white-space: nowrap;">
                            <td style="vertical-align: top;">
                                <a href="#" class="associated_drug" 
                                data-drugbank_id="${row.drug_bankID}"
                                onclick="toggleDivVisibility(this, '${drug_url}')" 
                                data-target="#atc_right">
                                ${row.drug_bankID}
                                </a> <a href="https://go.drugbank.com/drugs/${row.drug_bankID}" style="font-size:14px; color:grey; text-decoration: underline;" target="_blank";>[Ref]</a>
                            </td>
                            <td style="vertical-align: top;" >${row.name}</td>
                            <td style="vertical-align: top; text-align: center;">${row.target_list.length}</td>
                            <td style="white-space: normal;">${targetLinks}</td>
                            <td class="long-content" style="vertical-align: top;">${row.description}</td>
                        </tr>
                        `
                    }
                    tableHtml += '</tbody></table>';
                    var verb = "";
                    if (associations.length == 1) {
                        right_panel_text.innerHTML = "Drug '"+associations[0].name + "' and " + response.total_interaction + " proteins are in the network associated with " + response.atc_code;
                    } else {
                        right_panel_text.innerHTML = "There are " + associations.length + " drugs, " +  response.no_of_interacted_protein + " proteins, " + response.total_interaction + " interactions in the network associated with " + response.atc_code;
                    }
                    var atc_url = "{% url 'drugs_network' %}"+"?drug_bank_ids="+drug_bank_ids.toString();
                    right_panel_text_guide.style.fontWeight = "italic";
                    right_panel_text_guide.style.display = "block";
                    right_panel_text_guide.style.marginBottom = "10px";
                    var right_panel_content = document.createElement("div");
                    right_panel_content.id = "atc_right_table";
                    right_panel_content.style.marginRight = '30px';
                    right_panel_content.innerHTML = tableHtml;
                    right_panel.appendChild(right_panel_text);
                    if (associations.length > 1) {
                        right_panel_text_guide.innerHTML = `</br> <i>** In the 1st column, click on each Drugbank ID to show the individual network for that specific drug or click <a onclick="toggleDivVisibility(this, '${atc_url}')">here</a> to switch back to the ATC level network of </i> ${response.atc_code}
                        </br> <i>** In the 4th column, on each gene name, <u>click</u> to roll to the view of target-drug; <u>double click</u> to open the gene detail page; </i>
                        </br> <i>*** Also in the 4th column, on each gene name, its color indicates type of interaction, as <span class="text target"/> target </span>, <span class="text transporter"/> transporter </span>, <span class="text carrier"/> carrier </span>, and <span class="text enzyme"/> enzyme </span>`;
                    }
                    else{
                        right_panel_text_guide.innerHTML = `</br> <i>** In the 4th column, on each gene name, <u>click</u> to roll to the view of target-drug; <u>double click</u> to open the gene detail page; </i> 
                        </br> <i>*** Also in the 4th column, on each gene name, its color indicates type of interaction, as <span class="text target"/> target </span>, <span class="text transporter"/> transporter </span>, <span class="text carrier"/> carrier </span>, and <span class="text enzyme"/> enzyme </span>`;
                    }
                    right_panel.appendChild(right_panel_text_guide);
                    right_panel.appendChild(right_panel_content);
                    
                    // Adding the atc_level_network_statistics if there is drug associated with this ATC code
                    var atc_level_network_statistics = document.getElementById("atc_level_network_statistics");
                    atc_level_network_statistics.style.display="block";
                    
                    var atc_level_network_burden = document.getElementById("genebased-burden-distribution");
                    atc_level_network_burden.style.display="block";
                    
                    var atc_level_network_statistics_text = document.getElementById("atc_level_network_statistics_text");
                    atc_level_network_statistics_text.style.marginLeft = "10px";
                    atc_level_network_statistics_text.style.marginTop = "10px";
                    
                    $("#genebased-burden-distribution-area").find('input[name="burden-control"]').attr('data-atc-code', response.atc_code);
                    $("#genebased-burden-distribution-area").find('button.exportBtn').attr('data-atc-code', response.atc_code);
                    var genebased_burden_distribution_area = document.getElementById("genebased-burden-distribution-area");

                    if (response.atc_code!="no ATC code")
                    {
                        atc_level_network_statistics_text.innerHTML="Network statistics for "+response.atc_code;
                        showAtcLevelNetworkStatistics(response.atc_code);
                    }else{
                        atc_level_network_statistics_text.innerHTML="Network statistics";
                        showOneDrugLevelNetworkStatistics(response.drug_id);
                        }

                    var gene_based_burden_data = response.gene_based_burden_data;
                    if (gene_based_burden_data.length>0)
                    {
                        genebased_burden_distribution_area.style.display="block";
                        var tableHtml = '<table class="display compact text-nowrap" id="genebased-burden-distribution-table"><thead id="headers" style="text-align: left;"><tr><th style="white-space: nowrap;">Drugbank ID &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap;">Gene name&nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">MOA &nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">Annotation &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">n_cases &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">n_controls &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th>P-value </br>burden&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </th><th>BETA </br>burden&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;</th></tr></thead><tbody>';
                        
                        for (var k=0; k<gene_based_burden_data.length; k++){
                            row = gene_based_burden_data[k];
                            for (var l=0; l<row.burden_data.length; l++){
                                value = row.burden_data[l];
                                tableHtml+=`
                                <tr>
                                    <td style="vertical-align: top;" >${row.drug_id}</td>
                                    <td style="vertical-align: top;" >${row.gene_name}</td>
                                    <td style="vertical-align: top;" >${row.moa}</td>
                                    <td style="vertical-align: top;" >${value.annotation}</td>
                                    <td style="vertical-align: top;" >${value.n_cases}</td>
                                    <td style="vertical-align: top;" >${value.n_controls}</td>
                                    <td style="vertical-align: top;" >${Number(value.Pvalue_Burden).toFixed(3)}</td>
                                    <td style="vertical-align: top;" >${Number(value.BETA_Burden).toFixed(3)}</td>
                                </tr>`;
                            }
                        }
                        tableHtml += '</tbody></table>';
                        var genebased_burden_distribution_div = document.getElementById("genebased-burden-distribution-div");
                        genebased_burden_distribution_div.innerHTML = tableHtml;

                        let structures_scrollable = $("#genebased-burden-distribution-table");
                        structures_scrollable.show();
                        let oTable1 = structures_scrollable.DataTable({
                            deferRender: true,
                            scrollY: true,
                            scrollX: true,
                            scrollCollapse: true,
                            scroller: true,
                            paging: true,
                            bSortCellsTop: false, //prevent sort arrows going on bottom row
                            aaSorting: [],
                            autoWidth: true,
                            bInfo: true,
                            order: [[0, "asc"]],
                            pagingType: 'full_numbers',
                            lengthMenu: [
                                [5, 10],
                                [5, 10],
                            ],
                        });

                        let column_filters = [];
                        // createYADCFfilters(start_column, num_cols, filter_type, select_type = null, filter_default_label = "", filter_reset_button_text = false, filter_match_mode = null, column_data_type = null, width = null)
                        // Drug id
                        column_filters = column_filters.concat(createYADCFfilters(0, 1, "select", null, "select", false, null, null, "60px"));
                        //Gene
                        column_filters = column_filters.concat(createYADCFfilters(1, 1, "select", null, "select", false, null, null, "60px"));
                        //MOA
                        column_filters = column_filters.concat(createYADCFfilters(2, 1, "select", null, "select", false, null, null, "60px"));
                        //Annotation
                        column_filters = column_filters.concat(createYADCFfilters(3, 1, "select", null, "select", false, null, null, "60px"));
                        //n_cases
                        column_filters = column_filters.concat(createYADCFfilters(4, 1, "select", null, "select", false, null, null, "60px"));
                        //n_controls
                        column_filters = column_filters.concat(createYADCFfilters(5, 1, "select", null, "select", false, null, null, "60px"));
                        //p_value burden
                        column_filters = column_filters.concat(createYADCFfilters(6, 1, "range_number", null, ["Min", "Max"], false, null, null, width="70px"));
                        //BETA burden
                        column_filters = column_filters.concat(createYADCFfilters(7, 1, "range_number", null, ["Min", "Max"], false, null, null, width="70px"));
                        // update filters
                        yadcf.init(
                            oTable1,column_filters, {
                                cumulative_filtering: false,
                                rowCallBack: function(row, data) {
                                }
                            }
                        );
                        $(".yadcf-filter-wrapper").find('input.yadcf-filter-range-number.yadcf-filter-range').attr('size', '4');
                        $(".yadcf-filter-wrapper").find('input.yadcf-filter.ui-autocomplete-input').attr('size', '10')
                        $("#genebased-burden-distribution-table_filter").find("input").css("margin-left", "10px");
                } 
                }
                else { //if not (associations.length > 0) 
                    right_panel_text.innerHTML = "There is no targeting drugs associated with " + response.atc_code;
                    right_panel.appendChild(right_panel_text);
                    clean_drug_network()
                    var atc_level_network_statistics = document.getElementById("atc_level_network_statistics");
                    atc_level_network_statistics.style.display="none";
                }
            }
            
            $('input[name="burden-control"]').change(function() {
                
                var value_burden_control = $('input[name="burden-control"]').filter(":checked").val();
                var atc_code = $('input[name="burden-control"]').filter(":checked").data('atc-code');
                if (value_burden_control == "gene-based"){
                    var url = "{% url 'get-gene-based-burden-data-by-atc' %}?atc_code="+atc_code;
                    $.ajax(
                    {
                        url: url,
                        type: "GET",
                        success: function (response) {
                            create_pgx_genebased_table(response);
                            // $(".spinner").hide();
                        },
                        error: function (xhr, status, error) {
                            console.log('variant based pgx- AJAX Error:', error);
                        }
                    })
                }
                if (value_burden_control == "variant-based"){
                    $("#waiting-prompt").show();
                    $(".spinner").show();
                    $("#genebased-burden-distribution-div").hide();
                    var url = "{% url 'get-variant-based-burden-data-by-atc' %}?atc_code="+atc_code;
                    
                    $.ajax(
                    {
                        url: url,
                        type: "GET",
                        success: function (response) {
                            create_pgx_variant_based_table(response);
                            $(".spinner").hide();
                            $("#waiting-prompt").hide();
                            $("#genebased-burden-distribution-div").show();
                        },
                        error: function (xhr, status, error) {
                            console.log('AJAX Error:', error);
                        }
                    })
                }
                
            });

            function create_pgx_genebased_table(response){
                console.log("in create_pgx_genebased_table, len response = "+ response.length);
                var genebased_burden_distribution_area = document.getElementById("genebased-burden-distribution-area");
                genebased_burden_distribution_area.style.display="block";
                var gene_based_burden_data = response;
                if (gene_based_burden_data.length>0){
                    var tableHtml = '<table class="display compact text-nowrap" id="genebased-burden-distribution-table"><thead id="headers" style="text-align: left;"><tr><th style="white-space: nowrap;">Drugbank ID &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap;">Gene name&nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">MOA &nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">Annotation &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">n_cases &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">n_controls &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th>P-value </br>burden&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </th><th>BETA </br>burden&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;</th></tr></thead><tbody>';
                    
                    for (var k=0; k<gene_based_burden_data.length; k++){
                        row = gene_based_burden_data[k];
                        for (var l=0; l<row.burden_data.length; l++){
                            value = row.burden_data[l];
                            tableHtml+=`
                            <tr>
                                <td style="vertical-align: top;" >${row.drug_id}</td>
                                <td style="vertical-align: top;" >${row.gene_name}</td>
                                <td style="vertical-align: top;" >${row.moa}</td>
                                <td style="vertical-align: top;" >${value.annotation}</td>
                                <td style="vertical-align: top;" >${value.n_cases}</td>
                                <td style="vertical-align: top;" >${value.n_controls}</td>
                                <td style="vertical-align: top;" >${Number(value.Pvalue_Burden).toFixed(3)}</td>
                                <td style="vertical-align: top;" >${Number(value.BETA_Burden).toFixed(3)}</td>
                            </tr>`;
                        }
                    }
                    tableHtml += '</tbody></table>';
                    var genebased_burden_distribution_div = document.getElementById("genebased-burden-distribution-div");
                    genebased_burden_distribution_div.innerHTML = tableHtml;

                    let structures_scrollable = $("#genebased-burden-distribution-table");
                    structures_scrollable.show();
                    let oTable1 = structures_scrollable.DataTable({
                        deferRender: true,
                        scrollY: true,
                        scrollX: true,
                        scrollCollapse: true,
                        scroller: true,
                        paging: true,
                        bSortCellsTop: false, //prevent sort arrows going on bottom row
                        aaSorting: [],
                        autoWidth: true,
                        bInfo: true,
                        order: [[0, "asc"]],
                        pagingType: 'full_numbers',
                        lengthMenu: [
                            [5, 10],
                            [5, 10],
                        ],
                    });

                    let column_filters = [];
                        // createYADCFfilters(start_column, num_cols, filter_type, select_type = null, filter_default_label = "", filter_reset_button_text = false, filter_match_mode = null, column_data_type = null, width = null)
                        // Drug id
                        column_filters = column_filters.concat(createYADCFfilters(0, 1, "select", null, "select", false, null, null, "60px"));
                        //Gene
                        column_filters = column_filters.concat(createYADCFfilters(1, 1, "select", null, "select", false, null, null, "60px"));
                        //MOA
                        column_filters = column_filters.concat(createYADCFfilters(2, 1, "select", null, "select", false, null, null, "60px"));
                        //Annotation
                        column_filters = column_filters.concat(createYADCFfilters(3, 1, "select", null, "select", false, null, null, "60px"));
                        //n_cases
                        column_filters = column_filters.concat(createYADCFfilters(4, 1, "select", null, "select", false, null, null, "60px"));
                        //n_controls
                        column_filters = column_filters.concat(createYADCFfilters(5, 1, "select", null, "select", false, null, null, "60px"));
                        //p_value burden
                        column_filters = column_filters.concat(createYADCFfilters(6, 1, "range_number", null, ["Min", "Max"], false, null, null, width="70px"));
                        //BETA burden
                        column_filters = column_filters.concat(createYADCFfilters(7, 1, "range_number", null, ["Min", "Max"], false, null, null, width="70px"));
                        // update filters
                        yadcf.init(
                            oTable1,column_filters, {
                                cumulative_filtering: false,
                                rowCallBack: function(row, data) {
                                }
                            }
                        );
                        $(".yadcf-filter-wrapper").find('input.yadcf-filter-range-number.yadcf-filter-range').attr('size', '4');
                        $(".yadcf-filter-wrapper").find('input.yadcf-filter.ui-autocomplete-input').attr('size', '10')
                        $("#genebased-burden-distribution-table_filter").find("input").css("margin-left", "10px");

                        // $(".yadcf-filter-wrapper").find('span.yadcf-filter-range-number-seperator').each(function () {
                        //     $(this).html('<br>');
                        // })
                }

            }

            function create_pgx_variant_based_table(response){
                var genebased_burden_distribution_area = document.getElementById("genebased-burden-distribution-area");
                genebased_burden_distribution_area.style.display="block";
                var gene_based_burden_data = response;
                if (gene_based_burden_data.length>0){
                    var tableHtml = '<table class="display compact text-nowrap" id="genebased-burden-distribution-table"><thead id="headers" style="text-align: left;"><tr><th style="white-space: nowrap;">Drugbank ID &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap;">Gene name&nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">MOA &nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">VariantID &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">Annotation &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">n_cases &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">n_controls &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th>P-value </br>burden&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </th><th>BETA </br>burden&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;</th><th>AC </br>burden&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;</th><th>AF </br>burden&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;</th></tr></thead><tbody>';
                    
                    for (var k=0; k<gene_based_burden_data.length; k++){
                        row = gene_based_burden_data[k];
                        for (var l=0; l<row.burden_data.length; l++){
                            value = row.burden_data[l];
                            tableHtml+=`
                            <tr>
                                <td style="vertical-align: top;" >${row.drug_id}</td>
                                <td style="vertical-align: top;" >${row.gene_name}</td>
                                <td style="vertical-align: top;" >${row.MOA}</td>
                                <td style="vertical-align: top;" >${row.variant_marker}</td>
                                <td style="vertical-align: top;" >${value.annotation}</td>
                                <td style="vertical-align: top;" >${value.n_cases}</td>
                                <td style="vertical-align: top;" >${value.n_controls}</td>
                                <td style="vertical-align: top;" >${Number(value.Pvalue).toFixed(3)}</td>
                                <td style="vertical-align: top;" >${Number(value.BETA).toFixed(3)}</td>
                                <td style="vertical-align: top;" >${Number(value.AC).toFixed(3)}</td>
                                <td style="vertical-align: top;" >${Number(value.AF).toFixed(3)}</td>
                            </tr>`;
                        }
                    }
                    tableHtml += '</tbody></table>';
                    var genebased_burden_distribution_div = document.getElementById("genebased-burden-distribution-div");
                    genebased_burden_distribution_div.innerHTML = tableHtml;

                    let structures_scrollable = $("#genebased-burden-distribution-table");
                    structures_scrollable.show();
                    let oTable1 = structures_scrollable.DataTable({
                        deferRender: true,
                        scrollY: true,
                        scrollX: true,
                        scrollCollapse: true,
                        scroller: true,
                        paging: true,
                        bSortCellsTop: false, //prevent sort arrows going on bottom row
                        aaSorting: [],
                        autoWidth: true,
                        bInfo: true,
                        order: [[0, "asc"]],
                        pagingType: 'full_numbers',
                        lengthMenu: [
                            [5, 10],
                            [5, 10],
                        ],
                    });

                    let column_filters = [];
                        // createYADCFfilters(start_column, num_cols, filter_type, select_type = null, filter_default_label = "", filter_reset_button_text = false, filter_match_mode = null, column_data_type = null, width = null)
                        // Drug id
                        column_filters = column_filters.concat(createYADCFfilters(0, 1, "select", null, "select", false, null, null, "60px"));
                        //Gene
                        column_filters = column_filters.concat(createYADCFfilters(1, 1, "select", null, "select", false, null, null, "60px"));
                        //MOA
                        column_filters = column_filters.concat(createYADCFfilters(2, 1, "select", null, "select", false, null, null, "60px"));
                        //Variant marker
                        column_filters = column_filters.concat(createYADCFfilters(3, 1, "select", null, "select", false, null, null, "60px"));
                        //annotation
                        column_filters = column_filters.concat(createYADCFfilters(4, 1, "select", null, "select", false, null, null, "60px"));
                        //n_cases 
                        column_filters = column_filters.concat(createYADCFfilters(5, 1, "select", null, "select", false, null, null, "60px"));
                        //n_controls  
                        column_filters = column_filters.concat(createYADCFfilters(6, 1, "select", null, "select", false, null, null, width="70px"));
                        //p_value  
                        column_filters = column_filters.concat(createYADCFfilters(7, 1, "range_number", null, ["Min", "Max"], false, null, null, width="70px"));
                        //BETA 
                        column_filters = column_filters.concat(createYADCFfilters(8, 1, "range_number", null, ["Min", "Max"], false, null, null, width="70px"));
                        //AC
                        column_filters = column_filters.concat(createYADCFfilters(9, 1, "range_number", null, ["Min", "Max"], false, null, null, width="70px"));
                        //AF
                        column_filters = column_filters.concat(createYADCFfilters(10, 1, "range_number", null, ["Min", "Max"], false, null, null, width="70px"));

                        // update filters
                        yadcf.init(
                            oTable1,column_filters, {
                                cumulative_filtering: false,
                                rowCallBack: function(row, data) {
                                }
                            }
                        );
                        $(".yadcf-filter-wrapper").find('input.yadcf-filter-range-number.yadcf-filter-range').attr('size', '4');
                        $(".yadcf-filter-wrapper").find('input.yadcf-filter.ui-autocomplete-input').attr('size', '10')
                        $("#genebased-burden-distribution-table_filter").find("input").css("margin-left", "10px");

                        // $(".yadcf-filter-wrapper").find('span.yadcf-filter-range-number-seperator').each(function () {
                        //     $(this).html('<br>');
                        // })
                }
            }

        $(document).ready(function() {
            $(".yadcf-filter-wrapper").find('input.yadcf-filter.ui-autocomplete-input').parentsUntil('th').css('width', '40px');
            $(".yadcf-filter-wrapper").find('input.yadcf-filter.ui-autocomplete-input').parentsUntil('td').css('width', '40px');
            $(".yadcf-filter-wrapper").find('input.yadcf-filter.ui-autocomplete-input').attr('size', '10');
            $(".yadcf-filter-wrapper").find('input.yadcf-filter-range-number.yadcf-filter-range').parentsUntil('th').css('width', '40px');
            $(".yadcf-filter-wrapper").find('input.yadcf-filter-range-number.yadcf-filter-range').parentsUntil('td').css('width', '40px');
            $(".yadcf-filter-wrapper").find('input.yadcf-filter-range-number.yadcf-filter-range').attr('size', '10');
            
        });
        // Get all the network buttons defined in left_navigation.html
        const networkButtons = document.querySelectorAll(".network-button");

        // Add event listeners to each button
        networkButtons.forEach((button, index) => {
            button.addEventListener("click", () => showATCLevelNetwork(index));
        });

        // Function to show the ATC level drug-target network where there is at least one drug
        function showATCLevelNetwork(index) {
            const button = networkButtons[index];
            const atcCode = button.getAttribute("data-atc-code");
            
            const url = button.getAttribute('data-remote-url'); //"{% url 'get-drug-atc-association' %}"
            $.ajax(
                {
                    url: url,
                    type: "GET",
                    data: {
                        'atc_code': atcCode,
                    },
                    success: function (response) {
                        list_associated_drugs_in_table(response);
                        draw_atc_level_network(button, response);
                    },
                    error: function (xhr, status, error) {
                        console.log('AJAX Error:', error);
                    }
                })
        }
            
        // a newwork where there is at least one drug
        function draw_atc_level_network(button, response) {
            var drug_bank_ids = [];
            associations = response.associations
            if (associations.length > 0) {
                for (var i = 0; i < associations.length; i++) {
                    var row = associations[i];
                    drug_bank_ids.push(row.drug_bankID);
                }
                var atc_url = "{% url 'drugs_network' %}" + "?drug_bank_ids=" + drug_bank_ids.toString();
                toggleDivVisibility(button, atc_url)
            }
        }

        //handle case where there are more parameters
        var urlParams = new URLSearchParams(window.location.search);
        
        //case 1: drug_id is passed when the drug has no atc code --> left panel just has None, no atc hierachy tree
        if (urlParams.has('drug_id')) 
        { //  drug_id: query_string param
                var drug_id = urlParams.get('drug_id')
                const button = networkButtons[0];
                $.ajax(
                    {
                        url: "{% url 'get-drug-association' %}?drug_id="+drug_id,
                        type: "GET",
                        success: function (response) {
                            list_associated_drugs_in_table(response);
                            draw_atc_level_network(button, response);
                            $(document).ready(function() {
                                // Use setTimeout to introduce a delay
                                setTimeout(function() {
                                    var linkToClick = $("#associated_drug_tbl").find('tbody').find('tr').eq(0).find('td').eq(0).find('a');
                                    // Trigger click event
                                    linkToClick.trigger('click');
                                    }, 1000);  
                                    
                            });
                        },
                        error: function (xhr, status, error) {
                            console.log('AJAX Error:', error);
                        }
                    });
        }

        
    });    
    </script>
{% endblock %}