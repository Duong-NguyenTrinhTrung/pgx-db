{% extends "home/base.html" %}
{% load static %}
{% csrf_token %}

{% block addon_css %}
<link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
<link rel="stylesheet" href="{% static '/home/css/font.awesome.all.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'drug/css/atc_lookup.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'drug/css/atc_detail.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'drug/css/atc_network_comparison.css' %}">
<style>
    .tooltip {
        background-color: #fff;
        color: #333333;
        font-weight: bolder;
        padding: 2px 3px;
        border-radius: 5px;
        font-size: 14px;
        position: absolute;
        z-index: 999;
        border: 1px solid #333333;
    }

    a:hover {
        cursor: pointer;
    }

    #atc_level_network_statistics {
        /* height: 400px; */
        display: none;
        width: 98%;
    }

    #atc_level_network_statistics span {
        font-size: 16px;
        color: #337ab7;
        font-weight: bold;
    }

    #pgx_data_display_area {
        display: none;
    }

    fieldset {
        display: block;
        margin-left: 2px;
        margin-right: 2px;
        padding-top: 0.35em;
        padding-bottom: 0.625em;
        padding-left: 0.75em;
        padding-right: 0.75em;
        border: 2px groove (internal value);
    }

    legend {
        border-bottom: unset;
    }

    .spinner {
        border: 4px solid #c0bdbd;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .carrier {
        background-color: #f9c80e;
    }

    .target {
        background-color: #ff99c8;
    }

    .transporter {
        background-color: #662e9b;
    }

    .enzyme {
        background-color: #43bccd;
    }

    .text.target {
        background: #ff99c8;
        color: white;
    }

    .text.transporter {
        background: #662e9b;
        color: white;
    }

    .text.carrier {
        background: #f9c80e;
        color: white;
    }

    .text.enzyme {
        background: #43bccd;
        color: white;
    }

    mark {
        background-color: yellow;
        border: 1px solid black;
    }

    #burden-data-control-div,
    #clinical-pgx-data-control-div {
        display: none;
    }


    input[type=radio]:disabled {
        color: red;
    }

    [type="radio"]:disabled {
        color: red;
    }

    input[type="radio"]:disabled + .label:before{
        box-shadow: inset 0 0 0 4px #f4f4f4;
        border-color: #333;
        background-color: red;
    }

    .legend {
            
        -style: none;
            padding: 0;
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 2px;
    }

    .legend-color {
        width: 10px;
        height: 10px;
        margin-right: 8px;
        border: 1px solid #000;  /* You can adjust the border color */
    }
    button.active {
        border: 2px solid red;
    }

    #optionExplanation {
        width: 200px;
        height: 200px;
        background-color: rgb(198, 220, 238);
    }
    .callouts--left:before {
        content: "";
        position: absolute;
        width: 0;
        height: 0;
        left: -42px;
        top: 17px;
        border: 10px solid transparent;
        border-right: 32px solid rgb(193,193,193); /* IE8 Fallback */
        border-right: 32px solid rgba(193,193,193,0.5);
        z-index: 2;
    }
    .callouts--left:after {
        content: "";
        position: absolute;
        width: 0;
        height: 0;
        left: -31px;
        top: 20px;
        border: 8px solid transparent;
        border-right: 24px solid #fff;
        z-index: 3;
    }
    .callouts {
        list-style-type: none;
    }
    .callouts li {
        display: inline-block;
        /* Real styles */
        position: relative;
            width: 22%;
            height: 100px;
        padding: 15px;
            background-color: #fff;
        border: 1px solid #c1c1c1;
            border-radius: 4px;
            box-shadow: 0 0 10px #c1c1c1;
    }
   


</style>

{% endblock %}

{% block content %}
{% autoescape off %}
<div class="grid-container">
    {% include 'atc_detail/left_navigation.html' %}
    <div id="atc_right" class="col-8">
        <!-- block for showing the drug table -->
        <div id='drug-table'>
        </div>
        <div id="tabs_network" style="display:none;">

            <!-- Nav tabs -->
            <ul class="nav nav-tabs" role="tablist">
              <li role="presentation" class="active"><a href="#tab_network_visualization" aria-controls="tab_network_visualization" role="tab" data-toggle="tab">Network visualization</a></li>
              <li role="presentation"><a href="#tab_network_statistics" aria-controls="tab_network_statistics" role="tab" data-toggle="tab">Network statistics</a></li>
              <li role="presentation"><a href="#tab_network_comparison" aria-controls="tab_network_comparison" role="tab" data-toggle="tab">Network comparison</a></li>
            </ul>
          
            <!-- Tab panes -->
            <div class="tab-content">
              <div role="tabpanel" class="tab-pane active" id="tab_network_visualization">
                <!-- block for showing network -->
                    <div class="forcenetworkgraph" id="graphvisibility"
                    style="display: none; width: 100%; margin: 10px 0; height: 1300px; ">
                        <p> <span style="color: red;" id="network_overview"></span> </p>
                        <iframe id="myIframe" style="
                                                            display: none;
                                                            width: 98%;
                                                            height: 100%;
                                                            border: #b4b1b1 1px solid;
                                                            margin-right: 5px;">
                        </iframe>
                    </div>
              </div>
              <div role="tabpanel" class="tab-pane" id="tab_network_statistics">
                <!-- block for showing the atc level network statistics -->
                <div id='atc_level_network_statistics' style="border: #b4b1b1 1px solid">
                    <p>
                        <span id="atc_level_network_statistics_text"> </span>
                    </p>
                    <div class="row" id="atc_level_network_statistics_with_protein">
                        <div class="col-md-2 col-sm-12" style="margin-right: -80px;">
                            <div id="moa_legend">
                                <ul class="legend">
                                    <li class="legend-item">
                                        <div class="legend-color" style="background-color: #ff99c8;"></div>
                                        Target
                                    </li>
                                    <li class="legend-item">
                                        <div class="legend-color" style="background-color: #43bccd;"></div>
                                        Enzyme
                                    </li>
                                    <li class="legend-item">
                                        <div class="legend-color" style="background-color: #662e9b;"></div>
                                        Transporter
                                    </li>
                                    <li class="legend-item">
                                        <div class="legend-color" style="background-color: #f9c80e;"></div>
                                        Carrier
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-12" style="margin-right: 60px">
                            <div class="card-body text-center" style="margin-left: 5px; margin-top: 20px;">
                                <p style="font-style: italic; text-align: left;">Mode of action</p>
                                <div id="chart-container-ATC-interaction-type" style="width: 150px; height: 150px;">
                                    <svg id="pie-chart-ATC-interaction-type"></svg>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-12" style="margin-right: -80px;">
                            <div id="dtype_legend">
                                <ul class="legend">
                                    <li class="legend-item">
                                        <div class="legend-color" style="background-color: #d62828;"></div>
                                        Small Molecule
                                    </li>
                                    <li class="legend-item">
                                        <div class="legend-color" style="background-color: #004e98;"></div>
                                        Biotech
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-12" style="margin-right: 60px">
                            <div class="card-body text-center" style="margin-left: 5px; margin-top: 20px;">
                                <p style="font-style: italic; text-align: left;">Drug type</p>
                                <div id="chart-container-ATC-drug-type" style="width: 150px; height: 150px;">
                                    <svg id="pie-chart-ATC-drug-type"></svg>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-12" style="margin-right: -80px;">
                            <div id="dstatus_legend">
                                <ul class="legend">
                                    <li class="legend-item">
                                        <div class="legend-color" style="background-color: #ee6055;"></div>
                                        Nutraceutical
                                    </li>
                                    <li class="legend-item">
                                        <div class="legend-color" style="background-color: #60d394;"></div>
                                        Experimental
                                    </li>
                                    <li class="legend-item">
                                        <div class="legend-color" style="background-color: #aaf683;"></div>
                                        Investigational
                                    </li>
                                    <li class="legend-item">
                                        <div class="legend-color" style="background-color: #ffd97d;"></div>
                                        Approved
                                    </li>
                                    <li class="legend-item">
                                        <div class="legend-color" style="background-color: #ff9b85;"></div>
                                        VetApproved
                                    </li>
                                    <li class="legend-item">
                                        <div class="legend-color" style="background-color: #e4c1f9;"></div>
                                        Illicit
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-12">
                            <div class="card-body text-center" style="margin-left: 5px; margin-top: 20px; ">
                                <p style="font-style: italic; text-align: left;">Drug clinical status</p>
                                <div id="chart-container-ATC-drug-status" style="width: 150px; height: 150px;">
                                    <svg id="pie-chart-ATC-drug-status"></svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row" id="atc_level_network_statistics_with_disease" style="display: none; margin-bottom: 120px;">
                        <div class="col-md-2 col-sm-12" style="margin-right: -80px;">
                            <div id="moa_legend">
                                <ul class="legend">
                                    <li class="legend-item">
                                        <div class="legend-color" style="background-color: steelblue;"></div>
                                        Phase 1
                                    </li>
                                    <li class="legend-item">
                                        <div class="legend-color" style="background-color: purple;"></div>
                                        Phase 2
                                    </li>
                                    <li class="legend-item">
                                        <div class="legend-color" style="background-color: cyan;"></div>
                                        Phase 3
                                    </li>
                                    <li class="legend-item">
                                        <div class="legend-color" style="background-color: magenta;"></div>
                                        Phase 4
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-12" style="margin-right: 60px">
                            <div class="card-body text-center" style="margin-left: 5px; margin-top: 20px;">
                                <p style="font-style: italic; text-align: left;">Drug-disease clinical trial phase</p>
                                <div id="chart-container-ATC-clinical-trial-phase" style="width: 150px; height: 150px;">
                                    <svg id="pie-chart-ATC-clinical-trial-phase"></svg>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-7 col-sm-12" style="margin-right: 60px">
                            <div class="card-body text-center" style="margin-left: 5px; margin-top: 20px;">
                                <p style="font-style: italic; text-align: left; display: inline-block;">Disease class</p>
                                <div id="chart-container-ATC-disease-class">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row" id="pgx_data_display_area">
                        <div id="pgx_data_display_area_inner" class="col-md-12 col-sm-12">
                            <button onclick="tableToExcel($(this))" type="button" class="btn btn-primary exportBtn"
                                style="width: 120px; float: left; margin-right: 20px; ">
                                Export to Excel
                            </button>
                            <div style="display: flex; gap: 10px; flex-direction: row;">
                                <div id="clinical-pgx-data-control-div">
                                    <fieldset style="width:250px; border-radius: 5px;">
                                        <legend
                                            style="font-size: 14px; margin-bottom:0; text-decoration: none; color: #337ab7;">
                                            Clinical PGx data</legend>
                                        <input id="variant-based-clinical-pgx-control" data-atc-code=""
                                            name="clinical-pgx-control" type="radio" class="custom-radio" value="variant-based-clinical-pgx" checked>
                                        <label for="variant-based-clinical-pgx-control">Variant-based</label>
                                        
                                    </fieldset>
                                </div>
                                <div id="burden-data-control-div" >
                                    <div style="display: flex; flex-direction: row; gap: 10px;">
                                        <fieldset style="width:250px; border-radius: 5px;">
                                            <legend
                                                style="font-size: 14px; margin-bottom:0; text-decoration: none; color: #337ab7;">
                                                Burden data</legend>
                                            <input id="genebased-burden-control" data-atc-code="" name="burden-control" type="radio" class="custom-radio"
                                                value="gene-based"="">
                                            <label for="genebased-burden-control">Gene-based</label>
                                            <input id="variant-based-burden-control" data-atc-code="" name="burden-control"
                                                type="radio" class="custom-radio" value="variant-based">
                                            <label for="variant-based-burden-control">Variant-based</label>
                                        </fieldset>
                                        <select id="atc-sublevel-select" multiple class="form-control input-lg" size="4" style="display: none; margin-top: 20px;">
                                            <option value="no-selection" selected="selected">Select a sub-level ATC code</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <p id="waiting-prompt" style="text-align: center; display: none"><i> <mark>Please kindly wait when
                                        the data is being loaded! </i></mark> </p>
                            <div class="spinner" style="display: none; margin: auto;">
                            </div>
                            <!-- A datatable here  -->
                            <div id="pgx-data-table-div" style="margin-top: 20px;">
                            </div>
                        </div>
                    </div>

                </div>
              </div>
              <div role="tabpanel" class="tab-pane" id="tab_network_comparison" >

                <div style="display: flex; flex-direction: row; gap: 20px; margin-top: 15px;">
                    <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
                        <label for="atc_comparison" style="font-size: 16px; color: rgb(51, 122, 183); font-weight: bold;">Input an ATC code for network comparison</label>
                        <input type="text" id="atc_comparison" placeholder="ATC code" style="width: 100%;">
                        <button id="btn-network-compare" type="button" style="width: 200px; border-radius: 5px;" class="btn-primary">Compare</button>
                    </div>
                    <div >
                        <select id="compare-type" multiple class="form-control input-lg" size="13">
                            <option value="no-selection" selected="selected">Select an option</option>
                            <!-- <option value="align_network">&nbsp;&nbsp;&nbsp;&nbsp;- Align network</option> -->
                            <option value="compare_network_size">&nbsp;&nbsp;&nbsp;&nbsp;- Compare Network size</option>
                            <option value="compare_association_distritution">&nbsp;&nbsp;&nbsp;&nbsp;- Compare Degree distritution (Drug-Disease network)</option>
                            <option value="compare_degree_distritution">&nbsp;&nbsp;&nbsp;&nbsp;- Compare Degree distritution (Drug-Protein network)</option>
                            <option value="compare_moa_distribution">&nbsp;&nbsp;&nbsp;&nbsp;- Compare Mode of Action distribution (Drug-Protein network)</option>
                            <option value="see_clinical_trial_phase_distribution">&nbsp;&nbsp;&nbsp;&nbsp;- Compare Clinical trial phase distribution (Drug-Disease network)</option>
                            <option value="measure_centralization_dd">&nbsp;&nbsp;&nbsp;&nbsp;- Compare Degree of Centralization (Drug-Disease network)</option>
                            <option value="measure_centralization_dp">&nbsp;&nbsp;&nbsp;&nbsp;- Compare Degree of Centralization (Drug-Protein network)</option>
                            <option value="calculate_path_length_DD">&nbsp;&nbsp;&nbsp;&nbsp;- Calculate Average path length (Drug-Disease network)</option>
                            <option value="calculate_path_length_DP">&nbsp;&nbsp;&nbsp;&nbsp;- Calculate Average path length (Drug-Protein network)</option>
                            <option value="detect_community_dd">&nbsp;&nbsp;&nbsp;&nbsp;- Detect community (Drug-Disease network)</option>
                            <option value="detect_community_dp">&nbsp;&nbsp;&nbsp;&nbsp;- Detect community (Drug-Protein network)</option>
                            <option value="see_common_and_unique_elements">&nbsp;&nbsp;&nbsp;&nbsp;- See Common and Unique network elements</option>
                            <!-- Connectivity measurement  -->
                            <!-- clique set and the independent set in graph theory  -->
                            <!-- Clustering  -->
                            <!-- dominating set definition in graph  -->
                            <!-- Centrality measures -->
                        </select>
                    </div>
                    <div id="selectionExplanation" style="display:none;">
                        <ul class="callouts">
                            <li class="callouts--left" id="optionExplanation"></li>
                        </ul>

                    </div>
                </div>

                <div id="result-compare-area" style="margin-top: 30px; display: flex; flex-direction: column; align-items: center;">
                    <h4 id="result-compare-area-text"></h4>
                    <table id="result-compare-table">
                    </table>
                    <div id="result-compare-box" style="display: flex; margin-top: 20px; width: 100%;">
                        <div style="width: 50%;" id="atc_code_box">
                        </div>
                        <div style="width: 50%;" id="atc_comparison_box">
                        </div>
                    </div>
                </div>
              </div>
            </div>
          </div>
        
        <!-- block for showing the target table -->
        <div id="target-table" style="display: none;">
            <span style="font-style: italic; margin-bottom: 10px;" id="info-target-table"></span>
            <!-- table  -->
            <div id="associated_target_tbl">
                <table id="associated_target_tbl">
                    <thead style="text-align: left;">
                        <tr style="background-color: #f2f2f2;">
                            <th style="white-space: nowrap;">Target &nbsp; &nbsp; &nbsp; &nbsp;</th>
                            <th style="white-space: nowrap;">No. of drugs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                                &nbsp; &nbsp;</th>
                            <th style="white-space: normal;">List of drugs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                                &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                                &nbsp; &nbsp;</th>
                            <th style="white-space: nowrap;">PGx information &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                                &nbsp; &nbsp; &nbsp;</th>
                            <th>Other &nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;</th>
                        </tr>
                    </thead>
                    <tbody id="content-target-table">
                    </tbody>
                </table>
            </div>
            <!-- plots below the target table  -->
            <div class="row">
                <div class="col-md-2 col-sm-12">
                    <div class="card-body text-center" style="margin-top: 20px;">
                        <p style="font-style: italic; text-align: left;">Mode of Action</p>
                        <!--PieChart Code here-->
                        <div id="chart-container-interaction-type" style="width: 200px; height: 200px;">
                            <svg id="pie-chart-interaction-type"></svg>
                        </div>
                        <!--PieChart End here-->
                    </div>
                </div>
                <div class="col-md-2 col-sm-12">
                    <div class="card-body text-center" style="margin-top: 20px;">
                        <p style="font-style: italic; text-align: left;">Drug type</p>
                        <!--PieChart Code here-->
                        <div id="chart-container-drug-type" style="width: 200px; height: 200px;">
                            <svg id="pie-chart-drug-type"></svg>
                        </div>
                        <!--PieChart End here-->
                    </div>
                </div>
                <div class="col-md-2 col-sm-12">
                    <div class="card-body text-center" style="margin-top: 20px;">
                        <p style="font-style: italic; text-align: left;">Drug clinical status</p>
                        <!--PieChart Code here-->
                        <div id="chart-container-drug-status" style="width: 200px; height: 200px;">
                            <svg id="pie-chart-drug-status"></svg>
                        </div>
                        <!--PieChart End here-->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endautoescape %}
{% endblock %}

{% block addon_js %}

<script src="{% static 'home/js/d3.v7.min.js' %}"></script>
<script src="{% static 'drug/js/target_table_statistics.js' %}"></script>
<script src="{% static 'drug/js/atc_network_statistics.js' %}"></script>
<script src="{% static 'drug/js/atc_network_comparison.js' %}"></script>

<script src="{% static 'home/js/datatables.min.js' %}"></script>
<script src="{% static 'home/js/bootstrap2-toggle.min.js' %}"></script>
<script src="{% static 'home/js/jquery.dataTables.yadcf.js' %}"></script>
<script src="{% static 'home/js/dataTables.buttons.min.js' %}"></script>

<script>
    // JavaScript for toggling the visibility of nested lists
    document.querySelectorAll('.tree .desc').forEach(function (el) {
        el.addEventListener('click', function () {
            var parentLi = el.parentElement;
            var ul = parentLi.querySelector('ul');
            if (ul) {
                if (ul.style.display === "" || ul.style.display === "none") {
                    ul.style.display = 'block';
                } else {
                    if (ul.style.display === 'block') {
                        ul.style.display = 'none';
                    }
                }
            }
        });
    });
</script>

<script>

    var countClick = 0;
    var timer = null;
    function showData(event, uniProt_ID) {
        countClick++;
        if (countClick === 1) {
            timer = setTimeout(function () {
                countClick = 0;
                showTargetTable(uniProt_ID)
            }, 500);
        } else {
            clearTimeout(timer);
            var urlOpen = event.getAttribute("data-href");
            window.open(urlOpen, "_blank");
            countClick = 0;
        }
    }
    function showTargetTable(uniProt_ID) {
        $.ajax(
            {
                url: "{% url 'get-drug-list-by-uniprotID' %}?uniProt_ID=" + uniProt_ID,
                type: "GET",
                success: function (response) {
                    displayDrugListByUniProt_ID(response.response_data);
                    const target_type_data = [
                        { category: "Target", value: response.response_data.NoOfTargetTypes },
                        { category: "Enzyme", value: response.response_data.NoOfEnzymeTypes },
                        { category: "Carrier", value: response.response_data.NoOfCarrierTypes },
                        { category: "Transporter", value: response.response_data.NoOfTransporterTypes },
                    ];
                    createPieChartForTargetType(target_type_data);

                    const drug_type_data = [
                        { category: "Small Molecule", value: response.response_data.NoOfSmallMolecule },
                        { category: "Biotech", value: response.response_data.NoOfBiotech },
                    ];
                    createPieChartForDrugType(drug_type_data);

                    const drug_status_data = [
                        { category: "Nutraceutical", value: response.response_data.NoOfNutraceuticalDrug },
                        { category: "Experimental", value: response.response_data.NoOfExperimentalDrug },
                        { category: "Investigational", value: response.response_data.NoOfInvestigationalDrug },
                        { category: "Approved", value: response.response_data.NoOfApprovedDrug },
                        { category: "VetApproved", value: response.response_data.NoOfVetApprovedDrug },
                        { category: "Illicit", value: response.response_data.NoOfIllicitDrug },
                    ];
                    createPieChartForDrugStatus(drug_status_data);
                },
                error: function (xhr, status, error) {
                    console.log('AJAX Error:', error);
                }
            });
    }

    function showOneDrugLevelNetworkStatistics(drug_id) {
        $.ajax(
            {
                url: "{% url 'get-drug-association' %}?drug_id=" + drug_id,
                type: "GET",
                success: function (response) {
                    // displayStatisticsByAtcCode(response.response_data);
                    const target_type_data = [
                        { category: "Target", value: response.NoOfTargetTypes },
                        { category: "Enzyme", value: response.NoOfEnzymeTypes },
                        { category: "Carrier", value: response.NoOfCarrierTypes },
                        { category: "Transporter", value: response.NoOfTransporterTypes },
                    ];
                    createPieChartForATCTargetType(target_type_data);
                    const drug_type_data = [
                        { category: "Small Molecule", value: response.NoOfSmallMolecule },
                        { category: "Biotech", value: response.NoOfBiotech },
                    ];
                    createPieChartForATCDrugType(drug_type_data);
                    const drug_status_data = [
                        { category: "Nutraceutical", value: response.NoOfNutraceuticalDrug },
                        { category: "Experimental", value: response.NoOfExperimentalDrug },
                        { category: "Investigational", value: response.NoOfInvestigationalDrug },
                        { category: "Approved", value: response.NoOfApprovedDrug },
                        { category: "VetApproved", value: response.NoOfVetApprovedDrug },
                        { category: "Illicit", value: response.NoOfIllicitDrug },
                    ];
                    createPieChartForATCDrugStatus(drug_status_data);
                },
                error: function (xhr, status, error) {
                    console.log('AJAX Error:', error);
                }
            });
    }

    function showAtcLevelNetworkStatistics(atc_code) {
        $.ajax(
            {
                url: "{% url 'get-statistics-by-atc' %}?atc_code=" + atc_code,
                type: "GET",
                success: function (response) {
                    // displayStatisticsByAtcCode(response.response_data);
                    const target_type_data = [
                        { category: "Target", value: response.NoOfTargetTypes },
                        { category: "Enzyme", value: response.NoOfEnzymeTypes },
                        { category: "Carrier", value: response.NoOfCarrierTypes },
                        { category: "Transporter", value: response.NoOfTransporterTypes },
                    ];
                    createPieChartForATCTargetType(target_type_data);
                    const drug_type_data = [
                        { category: "Small Molecule", value: response.NoOfSmallMolecule },
                        { category: "Biotech", value: response.NoOfBiotech },
                    ];
                    createPieChartForATCDrugType(drug_type_data);
                    const drug_status_data = [
                        { category: "Nutraceutical", value: response.NoOfNutraceuticalDrug },
                        { category: "Experimental", value: response.NoOfExperimentalDrug },
                        { category: "Investigational", value: response.NoOfInvestigationalDrug },
                        { category: "Approved", value: response.NoOfApprovedDrug },
                        { category: "VetApproved", value: response.NoOfVetApprovedDrug },
                        { category: "Illicit", value: response.NoOfIllicitDrug },
                    ];
                    createPieChartForATCDrugStatus(drug_status_data);
                    if (response.totalNoOfDisease>0){
                        $("#atc_level_network_statistics_with_disease").show();
                        const clinical_trial_phase = [
                            { category: "Phase 1", value: response.noOfPhase1 },
                            { category: "Phase 2", value: response.noOfPhase2 },
                            { category: "Phase 3", value: response.noOfPhase3 },
                            { category: "Phase 4", value: response.noOfPhase4 },
                        ];
                        createPieChartForATCClinicalTrialPhase(clinical_trial_phase);
                        createBarChartForATCDiseaseClass(response.disease_classes, response.disease_class_count);
                    }
                },
                error: function (xhr, status, error) {
                    console.log('AJAX Error:', error);
                }
            });
    }
    function showAtcLevelNetworkBurden(atc_code) {
        $.ajax(
            {
                url: "{% url 'get-gene-based-burden-data-by-atc' %}?atc_code=" + atc_code,
                type: "GET",
                success: function (response) {
                    //chart-container-ATC-gene-based-burden
                    const ATC_gene_based_burden_data = [
                        { category: "p_value_target", value: response.p_value_target },
                        { category: "p_value_transporter", value: response.p_value_transporter },
                        { category: "p_value_carrier", value: response.p_value_carrier },
                        { category: "p_value_enzyme", value: response.p_value_enzyme },
                        { category: "beta_value_target", value: response.beta_value_target },
                        { category: "beta_value_transporter", value: response.beta_value_transporter },
                        { category: "beta_value_carrier", value: response.beta_value_carrier },
                        { category: "beta_value_enzyme", value: response.beta_value_enzyme },
                    ];
                    createPieChartForATCGeneBasedBurden(ATC_gene_based_burden_data);
                },
                error: function (xhr, status, error) {
                    console.log('AJAX Error:', error);
                }
            });
    }

    function displayDrugListByUniProt_ID(data) {
        $("#content-target-table").html('');

        var target_area = document.getElementById('target-table');
        $("#infor-target-table").html(`<i>More information of <b>${data.Target} </b>`);

        var drug_list = [];
        for (var j = 0; j < data.ListOfDrugIDs.length; j++) {
            var drug_url = "{% url 'drug_network' %}" + "?drug_bank_id=" + data.ListOfDrugIDs[j];
            drug_list.push(`<i class="fa-solid fa-pills"><a href="#" class="associated_drug" 
                                    data-drugbank_id="${data.ListOfDrugIDs[j]}"
                                    onclick="toggleDivVisibility(this, '${drug_url}'); #chart" 
                                    data-target="#atc_right"> <span style="font-style: normal; font-family: 'Helvetica', 'Arial', sans-serif;">${data.ListOfDrugNames[j]}</span></a></br>`);
        }

        var tableHtml = `
                        <tr style="white-space: nowrap; background-color: rgba(241, 124, 14, 0.2);">
                            <td>${data.Genename}</td>
                            <td>${data.NoOfDrugs}</td>
                            <td style="white-space: normal;"><div id="list_of_drug_cell">${drug_list.join("")}</div></td>
                            <td style="white-space: normal;">Coming soon</td>
                            <td class="long-content" >Coming soon</td>
                        </tr>
                        `;
        $("#content-target-table").html(tableHtml);
        $('html, body').animate({
            scrollTop: $('#content-target-table').offset().top
        }, 2000);
        $("#target-table").show();
        var target_statistics_plot = document.createElement("div");
        target_statistics_plot.setAttribute("id", "target_statistics_plot");

        var drug_type_statistics_plot = document.createElement("div");
        drug_type_statistics_plot.setAttribute("id", "drug_type_statistics_plot");
    }

    // Function to show visualization
    function toggleDivVisibility(element, url) {
        var drugBankId = element.getAttribute('data-drugbank_id');
        var iframe = $("#myIframe");
        // var url = "https://entertainmentbuz.com/visual/d3/index1.html";
        iframe.attr('src', url);  // Set the iframe source using jQuery

        //showing the visualization module
        iframe.css('display', 'block');
        var element = $("#graphvisibility");
        element.css('display', 'block');
        element.css('color', 'grey');
    }

    function getHeaderContent(element) {
        var content = "";
        element.childNodes.forEach(function (value) {
            if (value.nodeType === Node.TEXT_NODE) {
                // console.log("Current textNode value is : ", value.nodeValue.trim());
                // sChildTextSum += value.nodeValue;
                content += ` ${value.nodeValue.trim()}`;
            }
        });
        return content;
    }

    function tableToExcel(element) {
        atc_code = element.data('atc-code');
        var encabezado = '<html><head><meta http-equiv="content-type" content="text/plain; charset=UTF-8"/><style> table, td {border:thin solid black} table {border-collapse:collapse}</style></head><body><table>';

        var header_el = $('#headers')
        var header_th_els = header_el.find('th')
        var header = ''
        for (var th_i = 0; th_i < header_th_els.length; th_i++) {
            header += '<th>' + getHeaderContent(header_th_els[th_i]) + '</th>'
        }
        header = '<tr>' + header + '</tr>'
        header = '<thead>' + header + '</thead>'
        var excel_content = ''
        // Lay toan bo data trong datatable, chi lay cac rows thoa man dieu kien filter
        var rows = $('#pgx-data-table').DataTable().rows({ search: 'applied' }).data()
        for (var i = 0; i < rows.length; i++) {
            var row = rows[i]
            excel_content += '<tr>'
            for (var j = 0; j < row.length; j++) {
                excel_content += '<td>' + row[j] + '</td>'
            }
            excel_content += '</tr>'
        }

        var piePagina = "</table></body></html>";
        var tabla = encabezado + header + excel_content + piePagina;
        var myBlob = new Blob([tabla], { type: 'application/vnd.ms-excel' });
        var url = window.URL.createObjectURL(myBlob);
        var a = document.createElement("a");
        document.body.appendChild(a);
        a.href = url;
        a.download = `${atc_code}.xls`;
        a.click();

        setTimeout(function () {
            window.URL.revokeObjectURL(url);
        }, 0);
    };
</script>

<!-- Showing all drugs associated with an ATC code -->
<script>

    function clean_drug_network() 
    {
        var drug_network = $('#graphvisibility');
        drug_network.css('display', 'none');
    }

    //datatable render function
    function render_clinical_pgx_data(pgx_clinical_data) {
        var tableHtml = '<table class="display compact text-nowrap" id="pgx-data-table"><thead id="headers" style="text-align: left;"><tr>'+
            '<th style="white-space: nowrap;">Drugbank ID &nbsp; &nbsp; &nbsp; &nbsp; </th>'+
            '<th style="white-space: nowrap;">Gene name &nbsp; &nbsp; &nbsp; &nbsp; </th>'+
            '<th style="white-space: nowrap; text-align: center;">MOA &nbsp; &nbsp; &nbsp; &nbsp;</th>'+
            '<th style="white-space: nowrap; text-align: center;">Variant/Haplotypes&nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</th>'+
            '<th style="white-space: nowrap; text-align: center;">PMID &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</th>'+
            '<th style="white-space: nowrap; text-align: left;">Phenotype<br>category &nbsp; &nbsp; &nbsp; &nbsp; </th>'+
            '<th >Significance &nbsp; &nbsp; &nbsp; &nbsp; </th>'+
            '<th>Alleles &nbsp; &nbsp; &nbsp; &nbsp; </th>'+
            '<th>P_Value &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;</th>'+
            '<th style="white-space: normal; text-align: left; margin-right: 20px;">Biogeographical<br>Groups &nbsp; &nbsp; &nbsp; &nbsp;</th>'+
            '<th style="text-align: right;">Study_Type &nbsp; &nbsp; &nbsp; &nbsp; </th>'+
            '<th>Study_Cases &nbsp; &nbsp; &nbsp; &nbsp;</th>'+
            '<th>Study_Controls &nbsp; &nbsp; &nbsp; &nbsp; </th>'+
            '<th>Direction_of_effect &nbsp; &nbsp; &nbsp; &nbsp; </th>'+
            '<th>PD_PK_terms &nbsp; &nbsp; &nbsp; &nbsp; </th>'+
            '<th >Metabolizer_types &nbsp; &nbsp; &nbsp; &nbsp;</th>'+
            '<th style="text-align: center;">Association &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</th>'+
            '<th style="text-align: center;">MORE DETAILS &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</th>'+
            '</tr></thead><tbody>';
        for (var k = 0; k < pgx_clinical_data.length; k++) {
            row = pgx_clinical_data[k];
            for (var l = 0; l < row.clinical_data.length; l++) {
                value = row.clinical_data[l];
                tableHtml += `
                    <tr>
                        <td style="vertical-align: top;" >${row.drug_id}</td>
                        <td style="vertical-align: top;" >${row.gene_name}</td>
                        <td style="vertical-align: top;" >${row.moa}</td>
                        <td style="vertical-align: top; white-space: normal;" >${value.Variant_or_Haplotypes}</td>
                        <td style="vertical-align: top;" >PMID:<a href="https://pubmed.ncbi.nlm.nih.gov/${value.PMID}" target="_blank">${value.PMID}</a></td>
                        <td style="vertical-align: top;" >${value.Phenotype_Category}</td>
                        <td style="vertical-align: top; white-space: normal;" >${value.Significance}</td>
                        <td style="vertical-align: top;" >${value.Alleles}</td>
                        <td style="vertical-align: top;" >${value.P_Value}&nbsp; &nbsp; &nbsp;&nbsp;</td>
                        <td style="vertical-align: top; white-space: normal;" >${value.Biogeographical_Groups}</td>
                        <td style="vertical-align: top; text-align: center;" >${value.Study_Type}</td>
                        <td style="vertical-align: top; " >${value.Study_Cases}</td>
                        <td style="vertical-align: top;" >${value.Study_Controls}</td>
                        <td style="vertical-align: top;" >${value.Direction_of_effect}</td>
                        <td style="vertical-align: top;" >${value.PD_PK_terms}</td>
                        <td style="vertical-align: top;" >${value.Metabolizer_types}</td>
                        <td style="vertical-align: top; white-space: normal;" >${value.Sentence}</td>
                        <td style="vertical-align: top; white-space: normal;" >${value.Notes}</td>
                    </tr>`;
            }
        }
        tableHtml += '</tbody></table>';
        var genebased_burden_distribution_div = document.getElementById("pgx-data-table-div");
        genebased_burden_distribution_div.innerHTML = tableHtml;
        let structures_scrollable = $("#pgx-data-table");
        structures_scrollable.show();
        let oTable1 = structures_scrollable.DataTable({
            deferRender: true,
            scrollY: true,
            scrollX: true,
            scrollCollapse: true,
            scroller: true,
            paging: true,
            bSortCellsTop: false, //prevent sort arrows going on bottom row
            aaSorting: [],
            autoWidth: true,
            bInfo: true,
            order: [[0, "asc"]],
            pagingType: 'full_numbers',
            lengthMenu: [
                [3, 5, 10, 20, 30],
                [3, 5, 10, 20, 30],
            ],
        });

        let column_filters = [];
        // createYADCFfilters(start_column, num_cols, filter_type, select_type = null, filter_default_label = "", filter_reset_button_text = false, filter_match_mode = null, column_data_type = null, width = null)
        // Drug id
        column_filters = column_filters.concat(createYADCFfilters(0, 1, "select", null, "select", false, null, null, "60px"));
        //Gene
        column_filters = column_filters.concat(createYADCFfilters(1, 1, "select", null, "select", false, null, null, "60px"));
        //MOA
        column_filters = column_filters.concat(createYADCFfilters(2, 1, "select", null, "select", false, null, null, "60px"));
        //Variant_or_Haplotypes
        // column_filters = column_filters.concat(createYADCFfilters(3, 1, "select", null, "select", false, null, null, "60px"));
        //PMID
        // column_filters = column_filters.concat(createYADCFfilters(4, 1, "select", null, "select", false, null, null, "60px"));
        //Phenotype_Category
        column_filters = column_filters.concat(createYADCFfilters(5, 1, "select", null, "select", false, null, null, "60px"));
        //Significance
        column_filters = column_filters.concat(createYADCFfilters(6, 1, "select", null, "select", false, null, null, "60px"));
        //Alleles
        // column_filters = column_filters.concat(createYADCFfilters(7, 1, "select", null, "select", false, null, null, width = "70px"));
        //P_Value
        // column_filters = column_filters.concat(createYADCFfilters(8, 1, "select", null, "select", false, null, null, width = "70px"));
        //Biogeographical_Groups
        column_filters = column_filters.concat(createYADCFfilters(9, 1, "auto_complete", null, "", false, null, null, width = "70px"));
        //Study_Type
        column_filters = column_filters.concat(createYADCFfilters(10, 1, "select", null, "select", false, null, null, width = "70px"));
        //Study_Cases
        column_filters = column_filters.concat(createYADCFfilters(11, 1, "select", null, "select", false, null, null, width = "70px"));
        //Study_Controls
        column_filters = column_filters.concat(createYADCFfilters(12, 1, "select", null, "select", false, null, null, width = "70px"));
        //Direction_of_effect
        column_filters = column_filters.concat(createYADCFfilters(13, 1, "select", null, "select", false, null, null, width = "70px"));
        //PD_PK_terms
        column_filters = column_filters.concat(createYADCFfilters(14, 1, "select", null, "select", false, null, null, width = "70px"));
        //Metabolizer_types
        // column_filters = column_filters.concat(createYADCFfilters(15, 1, "select", null, "select", false, null, null, width = "70px"));
        // update filters
        //Association (Sentence)
        // column_filters = column_filters.concat(createYADCFfilters(16, 1, "select", null, "select", false, null, null, width = "70px"));
        //MORE DETAILS (Notes)
        // column_filters = column_filters.concat(createYADCFfilters(17, 1, "select", null, "select", false, null, null, width = "70px"));
        yadcf.init(
            oTable1, column_filters, {
            cumulative_filtering: false,
            rowCallBack: function (row, data) {
            }
        }
        );
        $(".yadcf-filter-wrapper").find('input.yadcf-filter-range-number.yadcf-filter-range').attr('size', '4');
        $(".yadcf-filter-wrapper").find('input.yadcf-filter.ui-autocomplete-input').attr('size', '10')
        $("#pgx-data-table_filter").find("input").css("margin-left", "10px");
        var selectElement = $('select[name="pgx-data-table_length"]');
        //selectElement[0][1].selected = true; //still not make the datatable align well
    }

    function render_gene_based_burden_data(gene_based_burden_data) {
        var tableHtml = '<table class="display compact text-nowrap" id="pgx-data-table"><thead id="headers" style="text-align: left;"><tr><th style="white-space: nowrap;">Drugbank ID &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap;">Gene name&nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">MOA &nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">Annotation &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">n_cases &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">n_controls &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th>P-value </br>burden&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </th><th>BETA </br>burden&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;</th></tr></thead><tbody>';
        for (var k = 0; k < gene_based_burden_data.length; k++) {
            row = gene_based_burden_data[k];
            for (var l = 0; l < row.burden_data.length; l++) {
                value = row.burden_data[l];
                tableHtml += `
                    <tr>
                        <td style="vertical-align: top;" >${row.drug_id}</td>
                        <td style="vertical-align: top;" >${row.gene_name}</td>
                        <td style="vertical-align: top;" >${row.moa}</td>
                        <td style="vertical-align: top;" >${value.annotation}</td>
                        <td style="vertical-align: top;" >${Number(value.n_cases).toFixed(0)}</td>
                        <td style="vertical-align: top;" >${Number(value.n_controls).toFixed(0)}</td>
                        <td style="vertical-align: top;" >${Number(value.Pvalue_Burden).toFixed(3)}</td>
                        <td style="vertical-align: top;" >${Number(value.BETA_Burden).toFixed(3)}</td>
                    </tr>`;
            }
        }
        tableHtml += '</tbody></table>';
        var genebased_burden_distribution_div = document.getElementById("pgx-data-table-div");
        genebased_burden_distribution_div.innerHTML = tableHtml;

        let structures_scrollable = $("#pgx-data-table");
        structures_scrollable.show();
        let oTable1 = structures_scrollable.DataTable({
            deferRender: true,
            scrollY: true,
            scrollX: true,
            scrollCollapse: true,
            scroller: true,
            paging: true,
            bSortCellsTop: false, //prevent sort arrows going on bottom row
            aaSorting: [],
            autoWidth: true,
            bInfo: true,
            order: [[0, "asc"]],
            pagingType: 'full_numbers',
            lengthMenu: [
                [5, 10],
                [5, 10],
            ],
        });

        let column_filters = [];
        // createYADCFfilters(start_column, num_cols, filter_type, select_type = null, filter_default_label = "", filter_reset_button_text = false, filter_match_mode = null, column_data_type = null, width = null)
        // Drug id
        column_filters = column_filters.concat(createYADCFfilters(0, 1, "select", null, "select", false, null, null, "60px"));
        //Gene
        column_filters = column_filters.concat(createYADCFfilters(1, 1, "select", null, "select", false, null, null, "60px"));
        //MOA
        column_filters = column_filters.concat(createYADCFfilters(2, 1, "select", null, "select", false, null, null, "60px"));
        //Annotation
        column_filters = column_filters.concat(createYADCFfilters(3, 1, "select", null, "select", false, null, null, "60px"));
        //n_cases
        column_filters = column_filters.concat(createYADCFfilters(4, 1, "select", null, "select", false, null, null, "60px"));
        //n_controls
        column_filters = column_filters.concat(createYADCFfilters(5, 1, "select", null, "select", false, null, null, "60px"));
        //p_value burden
        column_filters = column_filters.concat(createYADCFfilters(6, 1, "range_number", null, ["Min", "Max"], false, null, null, width = "70px"));
        //BETA burden
        column_filters = column_filters.concat(createYADCFfilters(7, 1, "range_number", null, ["Min", "Max"], false, null, null, width = "70px"));
        // update filters
        yadcf.init(
            oTable1, column_filters, {
            cumulative_filtering: false,
            rowCallBack: function (row, data) {
            }
        }
        );
        $(".yadcf-filter-wrapper").find('input.yadcf-filter-range-number.yadcf-filter-range').attr('size', '4');
        $(".yadcf-filter-wrapper").find('input.yadcf-filter.ui-autocomplete-input').attr('size', '10')
        $("#pgx-data-table_filter").find("input").css("margin-left", "10px");
        
        // $(".yadcf-filter-wrapper").find('span.yadcf-filter-range-number-seperator').each(function () {
        //     $(this).html('<br>');
        // })
    }

    function render_variant_based_burden_data(variant_based_burden_data) {
        var tableHtml = '<table class="display compact text-nowrap" id="pgx-data-table"><thead id="headers" style="text-align: left;"><tr><th style="white-space: nowrap;">Drugbank ID &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap;">Gene name&nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">VariantID &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">Annotation &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">n_cases &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th style="white-space: nowrap; text-align: center;">n_controls &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </th><th>P-value </br>burden&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </th><th>BETA </br>burden&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;</th><th>AC </br>burden&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;</th><th>AF </br>burden&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;</th></tr></thead><tbody>';

        for (var k = 0; k < variant_based_burden_data.length; k++) {
            row = variant_based_burden_data[k];
            var interactions = variant_based_burden_data[k].interactions;
            for (var l = 0; l < row.burden_data.length; l++) {
                value = row.burden_data[l];
                
                tableHtml += `
                    <tr>
                        <td style="vertical-align: top;" >${row.drug_id}</td>
                        <td style="vertical-align: top;" >${value.genename}</td>
                        <td style="vertical-align: top;" >${value.variant_marker__VariantMarker}</td>
                        <td style="vertical-align: top;" >${value.annotation}</td>
                        <td style="vertical-align: top;" >${Number(value.n_cases).toFixed(0)}</td>
                        <td style="vertical-align: top;" >${Number(value.n_controls).toFixed(0)}</td>
                        <td style="vertical-align: top;" >${Number(value.Pvalue).toFixed(3)}</td>
                        <td style="vertical-align: top;" >${Number(value.BETA).toFixed(3)}</td>
                        <td style="vertical-align: top;" >${Number(value.AC).toFixed(3)}</td>
                        <td style="vertical-align: top;" >${Number(value.AF).toFixed(3)}</td>
                    </tr>`;
            }
        }
        tableHtml += '</tbody></table>';
        var genebased_burden_distribution_div = document.getElementById("pgx-data-table-div");
        genebased_burden_distribution_div.innerHTML = tableHtml;

        let structures_scrollable = $("#pgx-data-table");
        structures_scrollable.show();
        let oTable1 = structures_scrollable.DataTable({
            deferRender: true,
            scrollY: true,
            scrollX: true,
            scrollCollapse: true,
            scroller: true,
            paging: true,
            bSortCellsTop: false, //prevent sort arrows going on bottom row
            aaSorting: [],
            autoWidth: true,
            bInfo: true,
            order: [[0, "asc"]],
            pagingType: 'full_numbers',
            lengthMenu: [
                [5, 10],
                [5, 10],
            ],
        });

        let column_filters = [];
        // createYADCFfilters(start_column, num_cols, filter_type, select_type = null, filter_default_label = "", filter_reset_button_text = false, filter_match_mode = null, column_data_type = null, width = null)
        // Drug id
        column_filters = column_filters.concat(createYADCFfilters(0, 1, "select", null, "select", false, null, null, "60px"));
        //Gene
        column_filters = column_filters.concat(createYADCFfilters(1, 1, "select", null, "select", false, null, null, "60px"));
        //MOA
        // column_filters = column_filters.concat(createYADCFfilters(2, 1, "select", null, "select", false, null, null, "60px"));
        //Variant marker
        column_filters = column_filters.concat(createYADCFfilters(2, 1, "select", null, "select", false, null, null, "60px"));
        //annotation
        column_filters = column_filters.concat(createYADCFfilters(3, 1, "select", null, "select", false, null, null, "60px"));
        //n_cases 
        column_filters = column_filters.concat(createYADCFfilters(4, 1, "select", null, "select", false, null, null, "60px"));
        //n_controls  
        column_filters = column_filters.concat(createYADCFfilters(5, 1, "select", null, "select", false, null, null, width = "70px"));
        //p_value  
        column_filters = column_filters.concat(createYADCFfilters(6, 1, "range_number", null, ["Min", "Max"], false, null, null, width = "70px"));
        //BETA 
        column_filters = column_filters.concat(createYADCFfilters(7, 1, "range_number", null, ["Min", "Max"], false, null, null, width = "70px"));
        //AC
        column_filters = column_filters.concat(createYADCFfilters(8, 1, "range_number", null, ["Min", "Max"], false, null, null, width = "70px"));
        //AF
        column_filters = column_filters.concat(createYADCFfilters(9, 1, "range_number", null, ["Min", "Max"], false, null, null, width = "70px"));

        // update filters
        yadcf.init(
            oTable1, column_filters, {
            cumulative_filtering: false,
            rowCallBack: function (row, data) {
            }
        }
        );
        $(".yadcf-filter-wrapper").find('input.yadcf-filter-range-number.yadcf-filter-range').attr('size', '4');
        $(".yadcf-filter-wrapper").find('input.yadcf-filter.ui-autocomplete-input').attr('size', '10')
        $("#pgx-data-table_filter").find("input").css("margin-left", "10px");

        // $(".yadcf-filter-wrapper").find('span.yadcf-filter-range-number-seperator').each(function () {
        //     $(this).html('<br>');
        // })
    }


    function list_associated_drugs_in_table(response) {
        var right_panel = document.getElementById('drug-table');
        right_panel.innerHTML = "";
        var right_panel_text = document.createElement("span");
        right_panel_text.style.fontSize = "16px";
        right_panel_text.style.color = '#337ab7';
        right_panel_text.style.fontWeight = "bold";
        var right_panel_text_guide = document.createElement("span");
        right_panel_text_guide.style.fontSize = "14px";

        var associations = response.associations;
        var drug_bank_ids = [];
        // Check if the 'associations' key exists in the JSON response
        if (associations.length > 0) {
            var tableHtml = '<table id="associated_drug_tbl" ><thead style="text-align: left;"><tr><th style="white-space: nowrap;">Drugbank ID</th><th style="white-space: nowrap;">Drug name</th><th style="white-space: nowrap; text-align: center;">No. of </br>interacting proteins</th><th style="white-space: nowrap;">List of interacting proteins</br><i>(Show in gene names)</i> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</th><th>Short description of drug</th></tr></thead><tbody>';

            for (var i = 0; i < associations.length; i++) {
                var row = associations[i];
                drug_bank_ids.push(row.drug_bankID);
                var drug_url = "{% url 'drug_network' %}" + "?drug_bank_id=" + row.drug_bankID;
                var targetLinks = [];
                for (var j = 0; j < row.target_list.length; j++) {
                    var className = "enzyme"
                    if (row.target_list[j].moa == "target") {
                        className = "target";
                    }
                    else if (row.target_list[j].moa == "transporter") {
                        className = "transporter";
                    }
                    else if (row.target_list[j].moa == "carrier") {
                        className = "carrier";
                    }
                    targetLinks.push(`<a style="color: white;" class="uniProt_ID ${className}" onclick="showData(this, '${row.target_list[j].uniProt_ID}')" target="_blank" data-href="/gene/${row.target_list[j].gene_id}"> ${row.target_list[j].genename}</a>`);
                }
                tableHtml += `
                <tr style="white-space: nowrap;">
                    <td style="vertical-align: top;">
                        <a href="#" class="associated_drug" 
                        data-drugbank_id="${row.drug_bankID}"
                        onclick="toggleDivVisibility(this, '${drug_url}')" 
                        data-target="#atc_right">
                        ${row.drug_bankID}
                        </a> <a href="https://go.drugbank.com/drugs/${row.drug_bankID}" style="font-size:14px; color:grey; text-decoration: underline;" target="_blank";>[Ref]</a>
                    </td>
                    <td style="vertical-align: top;" >${row.name}</td>
                    <td style="vertical-align: top; text-align: center;">${row.target_list.length}</td>
                    <td style="white-space: normal;">${targetLinks}</td>
                    <td class="long-content" style="vertical-align: top;">${row.description}</td>
                </tr>
                `
            }
            tableHtml += '</tbody></table>';
            var verb = "";
            if (associations.length == 1) {
                right_panel_text.innerHTML = "Drug '" + associations[0].name + "' and " + response.total_interaction + " proteins are in the network associated with " + response.atc_code;
            } else {
                right_panel_text.innerHTML = "There are " + associations.length + " drugs, " + response.no_of_interacted_protein + " proteins, " + response.total_interaction + " interactions in the network associated with " + response.atc_code;
            }
            var atc_url = "{% url 'drugs_network' %}" + "?drug_bank_ids=" + drug_bank_ids.toString();
            right_panel_text_guide.style.fontWeight = "italic";
            right_panel_text_guide.style.display = "block";
            right_panel_text_guide.style.marginBottom = "10px";
            var right_panel_content = document.createElement("div");
            right_panel_content.id = "atc_right_table";
            right_panel_content.style.marginRight = '30px';
            right_panel_content.innerHTML = tableHtml;
            right_panel.appendChild(right_panel_text);
            if (associations.length > 1) {
                right_panel_text_guide.innerHTML = `</br> <i>** In the 1st column, click on each Drugbank ID to show the individual network for that specific drug or click <a onclick="toggleDivVisibility(this, '${atc_url}')">here</a> to switch back to the ATC level network of </i> ${response.atc_code}
                </br> <i>** In the 4th column, on each gene name, <u>click</u> to roll to the view of target-drug; <u>double click</u> to open the gene detail page; </i>
                </br> <i>*** Also in the 4th column, on each gene name, its color indicates type of interaction, as <span class="text target"/> target </span>, <span class="text transporter"/> transporter </span>, <span class="text carrier"/> carrier </span>, and <span class="text enzyme"/> enzyme </span>`;
            }
            else {
                right_panel_text_guide.innerHTML = `</br> <i>** In the 4th column, on each gene name, <u>click</u> to roll to the view of target-drug; <u>double click</u> to open the gene detail page; </i> 
                </br> <i>*** Also in the 4th column, on each gene name, its color indicates type of interaction, as <span class="text target"/> target </span>, <span class="text transporter"/> transporter </span>, <span class="text carrier"/> carrier </span>, and <span class="text enzyme"/> enzyme </span>`;
            }
            right_panel.appendChild(right_panel_text_guide);
            right_panel.appendChild(right_panel_content);

            // Adding the atc_level_network_statistics if there is drug associated with this ATC code
            var atc_level_network_statistics = document.getElementById("atc_level_network_statistics");
            atc_level_network_statistics.style.display = "block";
            $("#tabs_network").show();
        }

        else { //if not (associations.length > 0) 
            right_panel_text.innerHTML = "There is no targeting drugs associated with " + response.atc_code;
            right_panel.appendChild(right_panel_text);
            clean_drug_network()
            var atc_level_network_statistics = document.getElementById("atc_level_network_statistics");
            atc_level_network_statistics.style.display = "none";
            $("#tabs_network").hide();
        }
    };

    function showAtcLevelNetworkStatistics2(atc_code) {
        // Adding the atc_level_network_statistics if there is drug associated with this ATC code
        var atc_level_network_statistics = document.getElementById("atc_level_network_statistics");
        atc_level_network_statistics.style.display = "block";

        var atc_level_network_statistics_text = document.getElementById("atc_level_network_statistics_text");
        atc_level_network_statistics_text.style.marginLeft = "10px";
        atc_level_network_statistics_text.style.marginTop = "10px";

        if (atc_code != "no ATC code") {
            atc_level_network_statistics_text.innerHTML = "Network statistics for " + atc_code;
            showAtcLevelNetworkStatistics(atc_code);
        } else {
            atc_level_network_statistics_text.innerHTML = "Network statistics";
            showOneDrugLevelNetworkStatistics(drug_id);
        }
    }

    function showPGxTable(atc_code){
        var pgx_data_display_area = document.getElementById("pgx_data_display_area");
        var pgx_data_display_area_inner = document.getElementById("pgx_data_display_area_inner");
        var clinical_pgx_data_control_area = document.getElementById("clinical-pgx-data-control-div");
        var burden_data_control_area = document.getElementById("burden-data-control-div");

        $("#pgx_data_display_area").find('input[name="clinical-pgx-control"]').attr('data-atc-code', atc_code);
        $("#pgx_data_display_area").find('input[name="burden-control"]').attr('data-atc-code', atc_code);
        $("#pgx_data_display_area").find('button.exportBtn').attr('data-atc-code', atc_code);

        // Get the radio buttons by their IDs
        const geneBasedRadio = document.getElementById('genebased-burden-control');
        const variantBasedRadio = document.getElementById('variant-based-burden-control');
        // Check the variant-based radio button and uncheck the gene-based radio button

        $.ajax(
            {
                url: "{% url 'get-clinical-pgx-data-by-atc' %}?atc_code=" + atc_code,
                type: "GET",
                success: function (clinical_response) {
                    if (clinical_response.length > 0 ){
                        //alert("yes, there are clinical_response data "+ clinical_response.length);
                        pgx_data_display_area.style.display = "block";
                        pgx_data_display_area_inner.style.display = "block";
                        clinical_pgx_data_control_area.style.display = "block";
                        render_clinical_pgx_data(clinical_response);
                        $.ajax(
                        {
                            url: "{% url 'get-gene-based-burden-data-by-atc' %}?atc_code=" + atc_code,
                            type: "GET",
                            success: function (burden_response) {
                                if (burden_response.length > 0 ){
                                    //alert("yes, there are GENE burden_response data");
                                    pgx_data_display_area.style.display = "block";
                                    pgx_data_display_area_inner.style.display = "block";
                                    burden_data_control_area.style.display = "block";
                                    //render_gene_based_burden_data(burden_response);
                                }else{
                                    $.ajax(
                                    {
                                        url: "{% url 'get-variant-based-burden-data-by-atc' %}?atc_code=" + atc_code,
                                        type: "GET",
                                        success: function (burden_response) {
                                            if (burden_response.length > 0 ){
                                                //alert("yes, there are VARIANT burden_response data");
                                                pgx_data_display_area.style.display = "block";
                                                pgx_data_display_area_inner.style.display = "block";
                                                burden_data_control_area.style.display = "block";
                                                //variantBasedRadio.checked = true;
                                                //render_gene_based_burden_data(burden_response);
                                            }
                                        },
                                        error: function (xhr, status, error) {
                                            console.log('AJAX Error:', error);
                                        }
                                    });
                                }

                            },
                            error: function (xhr, status, error) {
                                console.log('AJAX Error:', error);
                            }
                        });
                    }else{
                        //alert("no, there are no clinical_response data");
                        $.ajax(
                        {
                            url: "{% url 'get-gene-based-burden-data-by-atc' %}?atc_code=" + atc_code,
                            type: "GET",
                            success: function (burden_response) {
                                //alert("burden_response "+burden_response.length);
                                if (burden_response.length > 0 ){
                                    //alert("yes, there are burden_response data");
                                    pgx_data_display_area.style.display = "block";
                                    pgx_data_display_area_inner.style.display = "block";
                                    burden_data_control_area.style.display = "block";
                                    geneBasedRadio.checked = true;
                                    render_gene_based_burden_data(burden_response);
                                }else{
                                    $.ajax(
                                    {
                                        url: "{% url 'get-variant-based-burden-data-by-atc' %}?atc_code=" + atc_code,
                                        type: "GET",
                                        success: function (burden_response) {
                                            if (burden_response.length > 0 ){
                                                //alert("yes, there are VARIANT burden_response data");
                                                pgx_data_display_area.style.display = "block";
                                                pgx_data_display_area_inner.style.display = "block";
                                                burden_data_control_area.style.display = "block";
                                                variantBasedRadio.checked = true;
                                                geneBasedRadio.checked = false;
                                                geneBasedRadio.disabled = true;
                                                render_variant_based_burden_data(burden_response);
                                            }
                                        },
                                        error: function (xhr, status, error) {
                                            console.log('AJAX Error:', error);
                                        }
                                    });
                                    }
                            },
                            error: function (xhr, status, error) {
                                console.log('AJAX Error:', error);
                            }
                        });
                        }
                },
                error: function (xhr, status, error) {
                    console.log('AJAX Error:', error);
                }
            });
    }

    $('input[name="clinical-pgx-control"]').change(function () 
    {   
        $('input[name="burden-control"]').prop('checked', false);
        var atc_code = $('input[name="clinical-pgx-control"]').data('atc-code');
        var url = "{% url 'get-clinical-pgx-data-by-atc' %}?atc_code=" + atc_code;
        $.ajax(
                {
                    url: url,
                    type: "GET",
                    success: function (response) {
                        create_pgx_clinical_data_table(response);
                        // $(".spinner").hide();
                    },
                    error: function (xhr, status, error) {
                        console.log('clinical pgx- AJAX Error:', error);
                    }
                })
    });
    function create_pgx_clinical_data_table(response) {
        var pgx_data_display_area = document.getElementById("pgx_data_display_area");
        pgx_data_display_area.style.display = "block";
        if (response.length > 0) {
            render_clinical_pgx_data(response);

        }
    };
   
    $('input[name="burden-control"]').change(function () {
        var inp = $('#variant-based-clinical-pgx-control').prop('checked', false);
        var value_burden_control = $('input[name="burden-control"]').filter(":checked").val();
        var atc_code = $('input[name="burden-control"]').filter(":checked").data('atc-code');
        if (value_burden_control == "gene-based") {
            var url = "{% url 'get-gene-based-burden-data-by-atc' %}?atc_code=" + atc_code;
            $.ajax(
                {
                    url: url,
                    type: "GET",
                    success: function (response) {
                        $("#pgx-data-table-div").hide();
                        create_pgx_genebased_table(response);
                        // $(".spinner").hide();
                    },
                    error: function (xhr, status, error) {
                        console.log('variant based pgx- AJAX Error:', error);
                    }
                })
        }
        if (value_burden_control == "variant-based") {
            // $("#waiting-prompt").show();
            // $(".spinner").show();
            $("#pgx-data-table-div").hide();
            var select = $("#atc-sublevel-select");
            select.show();
            var url = "{% url 'get-atc-sub-levels' %}?atc_code=" + atc_code;
            $.ajax(
                {
                    url: url,
                    type: "GET",
                    success: function (response) {
                        var optionSelect;
                        response.sub_atc_codes.forEach(function(item) 
                        {
                            //console.log("atc sub item "+item);
                            optionSelect += `<option value=${item.id}>${item.id} (${item.name})</option>`;
                        });
                        select.append(optionSelect);
                    },
                    error: function (xhr, status, error) {
                        console.log('variant based pgx- AJAX Error:', error);
                    }
                })
            // $.ajax(
            //     {
            //         url: url,
            //         type: "GET",
            //         success: function (response) {
            //             create_pgx_variant_based_table(response);
            //             $(".spinner").hide();
            //             $("#waiting-prompt").hide();
            //             $("#pgx-data-table-div").show();
            //         },
            //         error: function (xhr, status, error) {
            //             console.log('AJAX Error:', error);
            //         }
            //     })
        }
    });

    function create_pgx_genebased_table(response) {
        var pgx_data_display_area = document.getElementById("pgx_data_display_area");
        pgx_data_display_area.style.display = "block";
        if (response.length > 0) {
            render_gene_based_burden_data(response);

        }
    };

    function create_pgx_variant_based_table(response) {
        var pgx_data_display_area = document.getElementById("pgx_data_display_area");
        pgx_data_display_area.style.display = "block";
        if (response.length > 0) {
            render_variant_based_burden_data(response);
        }
    };

    $(document).ready(function () 
    {
        $(".yadcf-filter-wrapper").find('input.yadcf-filter.ui-autocomplete-input').parentsUntil('th').css('width', '40px');
        $(".yadcf-filter-wrapper").find('input.yadcf-filter.ui-autocomplete-input').parentsUntil('td').css('width', '40px');
        $(".yadcf-filter-wrapper").find('input.yadcf-filter.ui-autocomplete-input').attr('size', '10');
        $(".yadcf-filter-wrapper").find('input.yadcf-filter-range-number.yadcf-filter-range').parentsUntil('th').css('width', '40px');
        $(".yadcf-filter-wrapper").find('input.yadcf-filter-range-number.yadcf-filter-range').parentsUntil('td').css('width', '40px');
        $(".yadcf-filter-wrapper").find('input.yadcf-filter-range-number.yadcf-filter-range').attr('size', '10');

        // Get all the network buttons defined in left_navigation.html
        const networkButtons = document.querySelectorAll(".network-button");

        // Add event listeners to each button
        networkButtons.forEach((button, index) => {
            button.addEventListener("click", () => showATCLevelNetwork(index));
        });
        function removeActive(index) {
            for(var i=0; i<networkButtons.length;i++) {
                if (i != index) {
                    networkButtons[i].classList.remove("active");
                }
            }
        }
        // Function to show the ATC level drug-target network where there is at least one drug
        function showATCLevelNetwork(index) {
            removeActive(index);
            const button = networkButtons[index];
            //button.style.borderColor = "red"
            button.classList.add("active");
            const atcCode = button.getAttribute("data-atc-code");

            const url = button.getAttribute('data-remote-url'); //"{% url 'get-drug-atc-association' %}"
            $.ajax(
                {
                    url: url,
                    type: "GET",
                    data: {
                        'atc_code': atcCode,
                    },
                    success: function (response) {
                        list_associated_drugs_in_table(response);
                        // show tabs
                        $("#tabs_network").attr("data-atc-code", response.atc_code);
                        console.log("showATCLevelNetwork: " + $("#tabs_network").attr("data-atc-code") + "; response.atc_code: " + response.atc_code);
                        if (response.associations.length>0)
                        {
                            showAtcLevelNetworkStatistics2(response.atc_code);
                            showPGxTable(response.atc_code);
                            draw_atc_level_network(button, response);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log('AJAX Error:', error);
                    }
                })

            
        }

        // a newwork where there is at least one drug
        function draw_atc_level_network(button, response) {
            var drug_bank_ids = [];
            associations = response.associations
            if (associations.length > 0) {
                for (var i = 0; i < associations.length; i++) {
                    var row = associations[i];
                    drug_bank_ids.push(row.drug_bankID);
                }
                var atc_url = "{% url 'drugs_network' %}" + "?drug_bank_ids=" + drug_bank_ids.toString();
                toggleDivVisibility(button, atc_url)
            }
        }

        //handle case where there are more parameters
        var urlParams = new URLSearchParams(window.location.search);

        //case 1: drug_id is passed when the drug has no atc code --> left panel just has None, no atc hierachy tree
        if (urlParams.has('drug_id')) { //  drug_id: query_string param
            var drug_id = urlParams.get('drug_id')
            const button = networkButtons[0];
            $.ajax(
                {
                    url: "{% url 'get-drug-association' %}?drug_id=" + drug_id,
                    type: "GET",
                    success: function (response) {
                        list_associated_drugs_in_table(response);
                        draw_atc_level_network(button, response);
                        $(document).ready(function () {
                            // Use setTimeout to introduce a delay
                            setTimeout(function () {
                                var linkToClick = $("#associated_drug_tbl").find('tbody').find('tr').eq(0).find('td').eq(0).find('a');
                                // Trigger click event
                                linkToClick.trigger('click');
                            }, 1000);

                        });
                    },
                    error: function (xhr, status, error) {
                        console.log('AJAX Error:', error);
                    }
                });
        }
    });    

    function isValidATC(atc_comparison){
        return true;
    }

    $("#compare-type").on('change', function() {
        var compare_type = $(this).val();
        
        if (compare_type != "no-selection") {
            $("#selectionExplanation").show();

            if (compare_type == "compare_network_size") {
                $("#optionExplanation").html("Comparing 2 networks on number of nodes (drug, protein, disease), drug-protein interactions, and drug-disease association studies. This allows to see if one is larger or more complex than the other.");
            } else if (compare_type == "compare_degree_distritution") {
                $("#optionExplanation").html("Comparing 2 networks on distribution of degree of drug-protein interaction nodes . This helps to understand the connectivity patterns.");
            } else if (compare_type == "compare_association_distritution") {
                $("#optionExplanation").html("Comparing 2 networks on distribution of degree of drug-disease association nodes. This helps to understand the connectivity patterns.");
            } else if (compare_type == "compare_moa_distribution") {
                $("#optionExplanation").html("Examine the distribution of modes of action (target, transporter, enzyme) for drugs in both networks. This helps to identify if one network has a predominant mode of action.");
            } else if (compare_type == "see_clinical_trial_phase_distribution") {
                $("#optionExplanation").html("Analyze the distribution of clinical trial phases for drug-disease associations in each network. This helps to understand the focus of clinical studies.");
            } else if (compare_type == "measure_centralization_dd") {
                $("#optionExplanation").html("Measure the degree of centralization in each network to identify highly connected drug or disease nodes. This checks if one network has a more centralized structure than the other.");
            } else if (compare_type == "measure_centralization_dp") {
                $("#optionExplanation").html("Measure the degree of centralization in each network to identify highly connected drug or protein nodes. This checks if one network has a more centralized structure than the other.");
            }else if (compare_type == "calculate_path_length_DD") {
                $("#optionExplanation").html("Calculate the average shortest path length between drug or disease nodes in each network. This compares the efficiency of information transfer within the networks.");
            }else if (compare_type == "calculate_path_length_DP") {
                $("#optionExplanation").html("Calculate the average shortest path length between drug or protein nodes in each network. This compares the efficiency of information transfer within the networks.");
            }else if (compare_type == "detect_community_dd" || compare_type == "detect_community_dp") {
                $("#optionExplanation").html("Apply community detection algorithms to identify clusters or modules within each network. This compares the community structures to understand functional modules.");
            }else if (compare_type == "see_common_and_unique_elements") {
                $("#optionExplanation").html("Identify the common drugs, proteins, and diseases shared between the two networks. This highlights unique elements in each network to understand their specific characteristics.");
            }
            $("#optionExplanation").css("font-style", "italic").css("font-size", "12px");
        }
    });


    $("#btn-network-compare").click(function() {
        var compare_type = $("#compare-type").val();
        var urlCompare;
        var compareTask;
        var compareText;
        if (atc_comparison!="" & isValidATC(atc_comparison)){
                if(compare_type == "no-selection") {
                    alert("Please select a comparison type!");
                }
                else if(compare_type == "align_network") {
                    urlCompare = "{% url 'get_statistics_by_atc_for_network_size_comparison' %}";
                    compareTask= "alignNetwork";
                    $("#optionExplanation").html("abc");
                }
                else if(compare_type == "compare_network_size") { //not yet
                    urlCompare = "{% url 'get_statistics_by_atc_for_network_size_comparison' %}";
                    compareTask= "compareNetworkSize";
                    compareText = "Network size"
                    $("#optionExplanation").html("compare_network_size");
                }
                else if(compare_type == "compare_degree_distritution") {
                    urlCompare = "{% url 'get_data_for_comparing_network_degree_distribution' %}";
                    compareTask= "distributionPlot";
                    compareText = "Degree distribution of DRUG-PROTEIN network ";
                    $("#optionExplanation").html("compare_degree_distritution");
                }
                else if(compare_type == "compare_association_distritution") {
                    urlCompare = "{% url 'get_data_for_comparing_network_associate_distribution' %}";
                    compareTask= "distributionPlot";
                    compareText = "Degree distribution of DRUG-DISEASE network ";
                }
                else if(compare_type == "compare_moa_distribution") {
                    urlCompare = "{% url 'get_statistics_by_atc_code_for_MOA_comparison' %}";
                    compareTask= "distributionPlotCategory";
                    compareText = "DRUG-PROTEIN Mode of action distribution";
                }
                else if(compare_type == "see_clinical_trial_phase_distribution") {
                    urlCompare = "{% url 'get_statistics_by_atc_for_clinical_trial_phase_comparison' %}";
                    compareTask= "distributionPlotCategory";
                    compareText = "DRUG-DISEASE clinical trial phase distribution";
                }
                else if(compare_type == "calculate_path_length_DD") {
                    urlCompare = "{% url 'get_statistics_by_atc_for_calculating_average_path_length_drug_disease' %}";
                    compareTask= "calculatePathLengthDD";
                    compareText = "Calculate path length of DRUG-DISEASE network";
                }
                else if(compare_type == "calculate_path_length_DP") {
                    urlCompare = "{% url 'get_statistics_by_atc_for_calculating_average_path_length_drug_protein' %}";
                    compareTask= "calculatePathLengthDP";
                    compareText = "Calculate path length of DRUG-PROTEIN network";
                }
                else if(compare_type == "measure_centralization_dd") {
                    urlCompare = "{% url 'get_statistics_by_atc_for_measure_centralization_drug_disease' %}";
                    compareTask= "measureCentralizationDD";
                    compareText = "Centrality measurement of DRUG-DISEASE network";
                }
                else if(compare_type == "measure_centralization_dp") {
                    urlCompare = "{% url 'get_statistics_by_atc_for_measure_centralization_drug_protein' %}";
                    compareTask= "measureCentralizationDP";
                    compareText = "Centrality measurement of DRUG-PROTEIN network";
                }
                else if(compare_type == "detect_community_dd") {
                    urlCompare = "{% url 'get_statistics_by_atc_for_detecting_community_drug_disease' %}";
                    compareTask= "detectCommunityDD";
                    compareText = "Community of DRUG-DISEASE network";
                }
                else if(compare_type == "detect_community_dp") {
                    urlCompare = "{% url 'get_statistics_by_atc_for_detecting_community_drug_protein' %}";
                    compareTask= "detectCommunityDP";
                    compareText = "Community of DRUG-PROTEIN network";
                }
                else if(compare_type == "see_common_and_unique_elements") {
                    urlCompare = "{% url 'get_data_for_comparing_common_and_unique_network_element' %}";
                    compareTask= "commonUniqueElement";
                    compareText = "Common and Unique network elements";
                }
        }else{
            alert("Please enter a valid ATC code!");
        }
        var atc_code = $("#tabs_network").attr("data-atc-code");
        var atc_comparison = $("#atc_comparison").val();
        
        if (compareTask == "distributionPlot")
        {
            $.ajax( {
                url: `${urlCompare}?atc_code=${atc_code}&atc_comparison=${atc_comparison}`,
                type: "GET",
                success: function (response) {
                    console.log(response);
                    var dataAtcCode = response.atc_code.distribution;
                    var dataAtcComparison = response.atc_comparison.distribution;
                    var dataAll = response.both.distribution;
                    createDistributionPlot(dataAtcCode, dataAll, "atc_code_box", `${compareText} <br><br>ATC code: <span style="color: #3498db">${atc_code}</span>`);
                    createDistributionPlot(dataAtcComparison, dataAll, "atc_comparison_box", `${compareText} <br><br>ATC code: <span style="color: #3498db">${atc_comparison}</span>`);
                },
                error: function (xhr, status, error) {
                    console.log('AJAX Error:', error);
                }
            });
        }
        else if (compareTask == "distributionPlotCategory")
        {
            $.ajax( {
                url: `${urlCompare}?atc_code=${atc_code}&atc_comparison=${atc_comparison}`,
                type: "GET",
                success: function (response) {
                    console.log(response);
                    var dataAtcCode = response.atc_code;
                    var dataAtcComparison = response.atc_comparison;
                    if (dataAtcCode.classes.length){
                        createDistributionPlotForCategoryData(dataAtcCode.classes, dataAtcCode.class_count, "atc_code_box", `${compareText} <br><br>ATC code: <span style="color: #3498db">${atc_code}</span>`)
                    }
                    else{
                        $("#atc_code_box").html(`<h4 style="text-align: center; color: #3498db">${compareText} <br><br>ATC code: <span style="color: #3498db">${atc_code}</span></h4><br><br><br><h5 style="text-align: center;color: #d90429;">There is no such network!</h5>`);
                    }
                    if (dataAtcComparison.classes.length){
                        createDistributionPlotForCategoryData(dataAtcComparison.classes, dataAtcComparison.class_count, "atc_comparison_box", `${compareText} <br><br>ATC code: <span style="color: #3498db">${atc_comparison}</span>`)
                    }
                    else{
                        $("#atc_comparison_box").html(`<h4 style="text-align: center; color: #3498db">${compareText} <br><br>ATC code: <span style="color: #3498db">${atc_comparison}</span></h4><br><br><br><h5 style="text-align: center; color: #d90429;">There is no such network!</h5>`);
                    }
                },
            error: function (xhr, status, error) {
                console.log('AJAX Error:', error);
            }
            });
        }
        else if (compareTask == "compareNetworkSize")
        {
            $.ajax( {
                url: `${urlCompare}?atc_code=${atc_code}&atc_comparison=${atc_comparison}`,
                type: "GET",
                success: function (response) {
                    console.log(response);
                    var dataAtcCode = response.atc_code;
                    var dataAtcComparison = response.atc_comparison;
                    compareNetworkSize(dataAtcCode, dataAtcComparison, "result-compare-table", `${compareText}`)
                },
            error: function (xhr, status, error) {
                console.log('AJAX Error:', error);
            }
            });
        }
        else if (compareTask == "measureCentralizationDD")
        {
            $.ajax( {
                url: `${urlCompare}?atc_code=${atc_code}&atc_comparison=${atc_comparison}`,
                type: "GET",
                success: function (response) {
                    console.log(response);
                    var dataAtcCode = response.atc_code;
                    var dataAtcComparison = response.atc_comparison;
                    measureCentralizationDrugDisease(dataAtcCode, "atc_code_box", `${compareText} for <span style="color: #3498db">${atc_code}</span>`)
                    measureCentralizationDrugDisease(dataAtcComparison, "atc_comparison_box", `${compareText} for <span style="color: #3498db">${atc_comparison}</span>`)
                },
            error: function (xhr, status, error) {
                console.log('AJAX Error:', error);
            }
            });
        }
        else if (compareTask == "measureCentralizationDP")
        {
            $.ajax( {
                url: `${urlCompare}?atc_code=${atc_code}&atc_comparison=${atc_comparison}`,
                type: "GET",
                success: function (response) {
                    console.log(response);
                    var dataAtcCode = response.atc_code;
                    var dataAtcComparison = response.atc_comparison;
                    measureCentralizationDrugProtein(dataAtcCode, "atc_code_box", `${compareText} for <span style="color: #3498db">${atc_code}</span>`)
                    measureCentralizationDrugProtein(dataAtcComparison, "atc_comparison_box", `${compareText} for <span style="color: #3498db">${atc_comparison}</span>`)
                },
            error: function (xhr, status, error) {
                console.log('AJAX Error:', error);
            }
            });
        }
        else if (compareTask == "detectCommunityDD")
        {
            $.ajax( {
                url: `${urlCompare}?atc_code=${atc_code}&atc_comparison=${atc_comparison}`,
                type: "GET",
                success: function (response) {
                    console.log(response);
                    var dataAtcCode = response.atc_code;
                    var dataAtcComparison = response.atc_comparison;
                    detectingCommunityDrugDisease(dataAtcCode, "atc_code_box", `${compareText} for <span style="color: #3498db">${atc_code}</span>`);
                    detectingCommunityDrugDisease(dataAtcComparison, "atc_comparison_box", `${compareText} for <span style="color: #3498db">${atc_comparison}</span>`);
                },
            error: function (xhr, status, error) {
                console.log('AJAX Error:', error);
            }
            });
        }
        else if (compareTask == "detectCommunityDP")
        {
            $.ajax( {
                url: `${urlCompare}?atc_code=${atc_code}&atc_comparison=${atc_comparison}`,
                type: "GET",
                success: function (response) {
                    console.log(response);
                    var dataAtcCode = response.atc_code;
                    var dataAtcComparison = response.atc_comparison;
                    detectingCommunityDrugProtein(dataAtcCode, "atc_code_box", `${compareText} for <span style="color: #3498db">${atc_code}</span>`);
                    detectingCommunityDrugProtein(dataAtcComparison, "atc_comparison_box", `${compareText} for <span style="color: #3498db">${atc_comparison}</span>`);
                },
                error: function (xhr, status, error) {
                    console.log('AJAX Error:', error);
                }
            });
        }
        else if (compareTask == "calculatePathLengthDD")
        {
            $.ajax( {
                url: `${urlCompare}?atc_code=${atc_code}&atc_comparison=${atc_comparison}`,
                type: "GET",
                success: function (response) {
                    console.log(response);
                    var dataAtcCode = response.atc_code;
                    var dataAtcComparison = response.atc_comparison;
                    alert("calculatePathLength");
                    calculatePathLength(dataAtcCode, "atc_code_box", `${compareText} for <span style="color: #3498db">${atc_code}</span>`);
                    calculatePathLength(dataAtcComparison, "atc_comparison_box", `${compareText} for <span style="color: #3498db">${atc_comparison}</span>`);
                },
            error: function (xhr, status, error) {
                console.log('AJAX Error:', error);
            }
            });
        }
        else if (compareTask == "calculatePathLengthDP")
        {
            $.ajax( {
                url: `${urlCompare}?atc_code=${atc_code}&atc_comparison=${atc_comparison}`,
                type: "GET",
                success: function (response) {
                    console.log(response);
                    var dataAtcCode = response.atc_code;
                    var dataAtcComparison = response.atc_comparison;
                    calculatePathLength(dataAtcCode, "atc_code_box", `${compareText} for <span style="color: #3498db">${atc_code}</span>`);
                    calculatePathLength(dataAtcComparison, "atc_comparison_box", `${compareText} for <span style="color: #3498db">${atc_comparison}</span>`);
                },
            error: function (xhr, status, error) {
                console.log('AJAX Error:', error);
            }
            });
        }
        else if (compareTask == "commonUniqueElement")
        {
            $.ajax( {
                url: `${urlCompare}?atc_code=${atc_code}&atc_comparison=${atc_comparison}`,
                type: "GET",
                success: function (response) {
                    console.log(response);
                    var data = response;
                    commonAndUniqueNodes(data,`${compareText} <br> for <span style="color: #3498db">${atc_code}</span> and <span style="color: #3498db">${atc_comparison}</span>`);
                },
            error: function (xhr, status, error) {
                console.log('AJAX Error:', error);
            }
            });
        }
    })
</script>
{% endblock %}